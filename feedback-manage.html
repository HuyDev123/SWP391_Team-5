<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh sách lịch hẹn - Dịch Vụ Xét Nghiệm ADN</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="staff-auth.css" />
    <link rel="stylesheet" href="staff-style.css" />
    <style>
      body {
        display: flex;
        min-height: 100vh;
        background-color: #f5f5f5;
      }

      .text-container {
        display: flex;
        flex-direction: column;
      }

      #logout-btn.logout-btn i {
        margin-right: 8px;
        font-size: 18px;
      }
      .menu-title {
        padding: 20px 20px 10px 20px;
        color: #666;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        position: relative;
      }

      .menu-title::after {
        content: "";
        position: absolute;
        bottom: 5px;
        left: 20px;
        width: 30px;
        height: 2px;
        background: linear-gradient(90deg, #2196f3, #64b5f6);
        border-radius: 1px;
      }

      #mainMenu {
        padding: 10px 15px;
      }

      .menu-item {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        color: #555;
        text-decoration: none;
        border-radius: 12px;
        margin-bottom: 6px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        font-weight: 500;
      }

      .menu-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(33, 150, 243, 0.1),
          transparent
        );
        transition: left 0.6s ease;
      }

      .menu-item:hover::before {
        left: 100%;
      }

      .menu-item:hover {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.1),
          rgba(33, 150, 243, 0.05)
        );
        color: #2196f3;
        transform: translateX(8px);
        box-shadow: 0 4px 20px rgba(33, 150, 243, 0.2);
      }

      .menu-item.active {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        transform: translateX(8px);
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1);
      }

      .menu-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 14px;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.15),
          rgba(33, 150, 243, 0.08)
        );
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
      }

      .menu-icon::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.3),
          transparent 70%
        );
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: all 0.3s ease;
      }

      .menu-item:hover .menu-icon {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.9),
          rgba(255, 255, 255, 0.7)
        );
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
      }

      .menu-item:hover .menu-icon::after {
        width: 30px;
        height: 30px;
      }

      .menu-item.active .menu-icon {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.3),
          rgba(255, 255, 255, 0.1)
        );
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .menu-icon i {
        font-size: 18px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 1;
        position: relative;
      }

      .menu-item:hover .menu-icon i {
        transform: scale(1.2);
        color: #2196f3;
      }

      .menu-item.active .menu-icon i {
        color: white;
        transform: scale(1.1);
      }

      @media (max-width: 600px) {
        #logout-btn.logout-btn {
          width: 100%;
          font-size: 15px;
          padding: 10px 0;
        }
        .user-info {
          flex-direction: column;
          gap: 10px;
        }
        .user-details {
          text-align: center;
        }
      }

      /* Login buttons */
      .login-buttons {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }

      .google-login-btn,
      .demo-login-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        border: none;
      }

      .google-login-btn {
        background-color: white;
        color: #757575;
        border: 1px solid #dadce0;
      }

      .google-login-btn:hover {
        background-color: #f5f5f5;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .google-login-btn i {
        margin-right: 10px;
        color: #4285f4;
        font-size: 18px;
      }

      .demo-login-btn {
        background-color: #1976d2;
        color: white;
      }

      .demo-login-btn:hover {
        background-color: #1565c0;
      }

      .demo-login-btn i {
        margin-right: 10px;
      }

      /* Demo accounts dropdown */
      .demo-accounts-dropdown {
        position: absolute;
        top: 100%;
        left: 20px;
        right: 20px;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        z-index: 100;
        overflow: hidden;
      }

      .demo-account-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .demo-account-item:hover {
        background-color: #f5f5f5;
      }

      .demo-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        color: white;
        font-weight: 500;
      }

      .demo-info {
        display: flex;
        flex-direction: column;
      }

      .demo-name {
        font-size: 14px;
        font-weight: 500;
      }

      .demo-role {
        font-size: 12px;
        color: #666;
      } /* Main content styles */
      .main-content {
        margin-left: 280px;
        padding: 25px;
        width: calc(100% - 280px);
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      }

      .navbar {
        display: flex;
        margin: 20px 0;
        background-color: white;
        border-radius: 5px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        padding: 15px 20px;
        text-decoration: none;
        color: #333;
        display: flex;
        align-items: center;
        border-bottom: 2px solid transparent;
      }

      .nav-item.active {
        border-bottom: 2px solid #2196f3;
        color: #2196f3;
      }

      .nav-icon {
        margin-right: 10px;
      }

      /* Sample collection styles */
      .sample-header {
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.6),
            rgba(0, 0, 0, 0.6)
          ),
          url("assets/images/banner.jpg");
        background-size: cover;
        background-position: center;
        color: white;
        padding: 60px 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
      }

      .sample-header h1 {
        font-size: 32px;
        margin-bottom: 15px;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      }

      .sample-header p {
        font-size: 18px;
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.6;
      }

      .instruction-container {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .instruction-title {
        font-size: 24px;
        color: #2196f3;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .warning-box {
        background-color: #fff8e1;
        border-left: 4px solid #ff9800;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 5px 5px 0;
      }

      .warning-title {
        display: flex;
        align-items: center;
        font-weight: bold;
        margin-bottom: 10px;
        color: #e65100;
      }

      .warning-icon {
        margin-right: 10px;
        font-size: 20px;
      }

      .steps-container {
        margin-top: 30px;
      }

      .step {
        display: flex;
        margin-bottom: 30px;
        position: relative;
      }

      .step-number {
        width: 50px;
        height: 50px;
        background-color: #2196f3;
        color: white;
        font-size: 24px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 20px;
        flex-shrink: 0;
      }

      .step-content {
        flex: 1;
      }

      .step-title {
        font-size: 20px;
        margin-bottom: 10px;
        color: #333;
      }

      .step-description {
        color: #555;
        line-height: 1.6;
      }

      .step-image {
        width: 100%;
        max-width: 300px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .step-timeline {
        position: absolute;
        left: 24px;
        top: 50px;
        bottom: -30px;
        width: 2px;
        background-color: #2196f3;
      }

      .step:last-child .step-timeline {
        display: none;
      }

      .step-tip {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .step-tip-title {
        font-weight: bold;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        color: #0d47a1;
      }

      .step-tip-icon {
        margin-right: 8px;
      }

      .step-bullet-list {
        margin-top: 15px;
        margin-left: 5px;
        list-style-type: none;
      }

      .step-bullet-list li {
        position: relative;
        padding-left: 28px;
        margin-bottom: 12px;
        line-height: 1.6;
      }

      .step-bullet-list li:before {
        content: "•";
        position: absolute;
        left: 0;
        top: 0;
        color: #2196f3;
        font-size: 24px;
        line-height: 1;
      }

      .step-image-container {
        margin-top: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .step-image-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
      }

      .step-image {
        width: 100%;
        max-width: 400px;
        display: block;
        border-radius: 8px;
      }

      .step-content {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .step-text {
        flex: 1;
        min-width: 300px;
      }

      .step-visual {
        flex: 1;
        min-width: 300px;
        padding-left: 20px;
        display: flex;
        justify-content: center;
      }
      .sample-types {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .sample-type {
        flex: 1;
        min-width: 250px;
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #2196f3;
      }
      .sample-type:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        .step-content {
          flex-direction: column;
        }

        .step-visual {
          padding-left: 0;
          margin-top: 20px;
          width: 100%;
        }
      }
      .sample-type-title {
        font-size: 18px;
        margin-bottom: 10px;
        color: #333;
        display: flex;
        align-items: center;
      }

      .sample-type-icon {
        margin-right: 10px;
        color: #2196f3;
        font-size: 20px;
      }

      .sample-type-content {
        color: #555;
        line-height: 1.5;
      }

      /* Video section */
      .video-section {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }

      .video-title {
        font-size: 24px;
        color: #2196f3;
        margin-bottom: 20px;
      }

      .video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
        overflow: hidden;
        border-radius: 8px;
      }

      .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
      }

      /* FAQs section */
      .faq-section {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .faq-title {
        font-size: 24px;
        color: #2196f3;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .faq-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
      }

      .faq-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .faq-question {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
        display: flex;
        align-items: flex-start;
      }

      .question-icon {
        color: #2196f3;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .faq-answer {
        color: #555;
        line-height: 1.6;
        padding-left: 30px;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .main-content {
          margin-left: 0;
          width: 100%;
        }

        .step {
          flex-direction: column;
        }

        .step-number {
          margin-bottom: 15px;
          margin-right: 0;
        }

        .step-timeline {
          display: none;
        }
      }
      .highlighted-step {
        animation: highlight-step 3s ease;
      }

      @keyframes highlight-step {
        0%,
        100% {
          background-color: transparent;
        }
        20%,
        80% {
          background-color: rgba(33, 150, 243, 0.1);
          box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
          transform: translateY(-5px);
        }
      }

      /* Đảm bảo các bước có đủ padding cho hiệu ứng */
      .step {
        padding: 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-bottom: 30px;
      }
      .menu-icon i {
        font-size: 18px;
        width: 20px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .menu-item.active .menu-icon i {
        color: white;
      }

      .menu-item:hover .menu-icon i {
        transform: scale(1.1);
        color: #2196f3;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #2196f3;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #1976d2;
      }

      /* CSS chung cho các modal để đảm bảo hiển thị tốt trên mọi thiết bị */
      .modal-container {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Căn lề trên để dễ cuộn */
        padding: 20px 0;
      }

      /* Style chung cho iframe trong modal */
      .modal-iframe {
        background-color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        width: 100%;
        height: 85vh;
        max-height: calc(100vh - 60px);
        overflow: auto;
      }

      /* Kiểu hiển thị nút close */
      .modal-close-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 10002;
        background: white;
        color: #f44336;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.2s;
      }

      .modal-close-btn:hover {
        transform: scale(1.1);
        background: #ffebee;
      }

      /* Styling cho backdrop */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
        z-index: 10000;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .status-booked {
        background-color: rgba(33, 150, 243, 0.1);
        color: #2196f3;
      }

      .status-waiting {
        background-color: rgba(255, 152, 0, 0.1);
        color: #ff9800;
      }

      .status-received {
        background-color: rgba(25, 118, 210, 0.1);
        color: #1976d2;
      }

      .status-completed {
        background-color: rgba(76, 175, 80, 0.1);
        color: #4caf50;
      }

      .status-delivered {
        background-color: rgba(0, 150, 136, 0.1);
        color: #009688;
      }

      .status-cancelled {
        background-color: rgba(244, 67, 54, 0.1);
        color: #f44336;
      }

      /* CSS cho các trạng thái mới */
      .status-kit-pending {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }

      .status-kit-received {
        background-color: rgba(156, 39, 176, 0.1);
        color: #9c27b0;
      }

      .status-kit-returned {
        background-color: rgba(63, 81, 181, 0.1);
        color: #3f51b5;
      }

      .status-not-sampled {
        background-color: rgba(3, 169, 244, 0.1);
        color: #03a9f4;
      }

      .status-sampling-completed {
        background-color: rgba(139, 195, 74, 0.1);
        color: #8bc34a;
      }

      .status-sample-error {
        background-color: rgba(255, 87, 34, 0.1);
        color: #ff5722;
      }

      .status-final-completed {
        background-color: rgba(76, 175, 80, 0.1);
        color: #4caf50;
      }

      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        cursor: pointer;
      }

      .btn-primary {
        background: linear-gradient(45deg, #2196f3, #1976d2);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #4caf50, #388e3c);
        color: white;
      }
    </style>
    <!-- Thêm vào phần <head> của mỗi trang -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <style>
      /* Hiệu ứng chuyển động mượt mà */
      .hero-banner,
      .content-section,
      .service-card,
      .step-item,
      .contact-btn {
        transition: all 0.5s ease;
      }

      /* Cải thiện hero banner */
      .hero-banner {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .hero-banner:hover {
        transform: translateY(-5px);
      }

      /* Hiệu ứng cho các section */
      .content-section {
        transition: transform 0.4s ease, box-shadow 0.4s ease;
      }

      .content-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      }

      /* Hiệu ứng facility items */
      .facility-item {
        transition: all 0.4s ease;
      }

      .facility-item:hover {
        transform: translateY(-8px);
      }

      .facility-item .icon-wrapper {
        transition: all 0.5s ease;
      }

      .facility-item:hover .icon-wrapper {
        transform: rotateY(180deg);
      }

      /* Card hover effects */
      .service-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 30px rgba(33, 150, 243, 0.1);
      }

      .service-card .card-icon {
        transition: all 0.5s ease;
      }

      .service-card:hover .card-icon {
        transform: rotateY(360deg);
        background-color: #2196f3;
        color: white;
      }

      /* Step item animations */
      .step-item {
        position: relative;
        overflow: hidden;
      }

      .step-item:hover {
        background-color: #f9f9f9;
        padding-left: 15px;
        border-radius: 8px;
      }

      .step-item .step-number,
      .step-item .step-icon {
        transition: all 0.4s ease;
      }

      .step-item:hover .step-number {
        transform: scale(1.2);
      }

      .step-item:hover .step-icon {
        transform: rotate(360deg);
      }

      /* Contact button effects */
      .contact-btn {
        transform-origin: center;
        transition: all 0.3s ease;
      }

      .contact-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }

      .contact-btn i {
        transition: all 0.4s ease;
      }

      .contact-btn:hover i {
        transform: scale(1.2);
      }

      /* Sidebar menu hover effect */
      .menu-item {
        transition: all 0.3s ease;
      }

      .menu-item:hover .menu-icon {
        transform: scale(1.2);
        transition: transform 0.3s ease;
      }

      /* Gradient buttons */
      .login-register-btn {
        background-image: linear-gradient(45deg, #2196f3, #1976d2);
        transition: all 0.3s ease;
      }

      .login-register-btn:hover {
        background-image: linear-gradient(45deg, #1976d2, #0d47a1);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
      }

      /* Animation for facility section */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Specific styles for the filter form that won't be affected by global styles */
      .genx-filter-form {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 16px !important;
        align-items: center !important;
        margin-bottom: 20px !important;
        flex-direction: row !important; /* Override the column direction from global styles */
      }

      .genx-filter-form div {
        margin: 0 !important;
      }

      .genx-filter-form input,
      .genx-filter-form select {
        padding: 6px 10px !important;
        border: 1px solid #ccc !important;
        border-radius: 4px !important;
      }

      .genx-filter-form button[type="submit"] {
        background: #2196f3 !important;
        color: white !important;
        border: none !important;
        border-radius: 4px !important;
        padding: 8px 18px !important;
        cursor: pointer !important;
      }

      .genx-filter-form button[type="reset"] {
        background: #f5f5f5 !important;
        color: #333 !important;
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
        padding: 8px 18px !important;
        cursor: pointer !important;
        margin-left: 8px !important;
      }
    </style>
  </head>
  <body>
    <script th:inline="javascript">
      /*<![CDATA[*/
      window.serverStaff = /*[[${staffData}]]*/ null;
      /*]]>*/
    </script>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo-container">
        <img src="/assets/images/logo.png" alt="Logo" class="logo" />
        <div class="text-container">
          <div class="logo-text">Genx</div>
          <div class="logo-subtext">Trung tâm xét nghiệm ADN huyết thống</div>
        </div>
      </div>
      <div class="login-register" id="login-register">
        <div id="user-info-container"></div>
      </div>
      <div class="menu-title">MAIN MENU</div>
      <div id="mainMenu">
        <a href="/staff-home" class="menu-item">
          <span class="menu-icon"><i class="fas fa-home"></i></span>
          Trang chủ
        </a>

        <a href="/staff-appointments" class="menu-item">
          <span class="menu-icon"><i class="fas fa-clipboard-list"></i></span>
          Danh sách lịch hẹn
        </a>

        <a href="/staff-kit-list" class="menu-item">
          <span class="menu-icon"><i class="fas fa-vials"></i></span>
          Danh sách kit xét nghiệm
        </a>

        <a href="/staff-participants" class="menu-item">
          <span class="menu-icon"><i class="fas fa-users"></i></span>
          Quản lý người tham gia
        </a>

        <a href="/staff-samples" class="menu-item">
          <span class="menu-icon"><i class="fas fa-flask"></i></span>
          Quản lý mẫu xét nghiệm
        </a>

        <a href="/staff-results" class="menu-item">
          <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
          Quản lý kết quả xét nghiệm
        </a>

        <a href="/feedback-manage" class="menu-item active">
          <span class="menu-icon"><i class="fas fa-star"></i></span>
          Quản lý đánh giá
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Navigation Bar -->
      <div id="topNavbar" class="navbar">
        <!-- Navbar sẽ được thêm bằng JavaScript -->
      </div>
      <!-- Phần cần code -->
      <!-- ...existing code... -->
      <div class="instruction-container" style="margin-top: 10px">
        <div class="instruction-title">
          <i class="fas fa-star" style="color: #2196f3"></i>
          Quản lý đánh giá lịch hẹn đã hoàn thành
          <div style="font-size: 14px; color: #666; margin-top: 5px">
            <i class="fas fa-info-circle"></i> Chỉ hiển thị các lịch hẹn đã hoàn
            thành và có đánh giá từ khách hàng
          </div>
          <div class="demo-mode-toggle" style="float: right; margin-top: -5px">
            <button
              id="toggleDemoMode"
              class="btn"
              style="
                background: #ff9800;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 6px 12px;
                cursor: pointer;
              "
            >
              <i class="fas fa-flask"></i> Chế độ demo
            </button>
            <span
              id="demoModeStatus"
              style="
                margin-left: 8px;
                font-size: 14px;
                color: #666;
                display: none;
              "
            >
              <i class="fas fa-info-circle"></i> Đang hiển thị dữ liệu demo
            </span>
          </div>
        </div>
        <!-- Bộ lọc -->
        <form
          id="filterForm"
          class="genx-filter-form"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <div style="flex-grow: 1; max-width: 500px">
            <label for="searchFilter" style="font-weight: 500; color: #333"
              >Tìm kiếm:</label
            >
            <div style="display: flex; align-items: center">
              <input
                type="text"
                id="searchFilter"
                name="searchFilter"
                placeholder="Mã lịch hẹn, Tên KH"
                style="
                  padding: 8px 12px;
                  border: 1px solid #ccc;
                  border-radius: 4px 0 0 4px;
                  width: 100%;
                "
              />
              <button
                type="submit"
                style="
                  background: #2196f3;
                  color: white;
                  border: none;
                  border-radius: 0 4px 4px 0;
                  padding: 8px 16px;
                  cursor: pointer;
                  height: 37px;
                "
              >
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <!-- All filters removed except search - only showing completed appointments -->
        </form>

        <div style="overflow-x: auto">
          <table
            style="
              width: 100%;
              border-collapse: collapse;
              margin-top: 10px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              border-radius: 8px;
              overflow: hidden;
              margin-bottom: 20px;
            "
          >
            <thead>
              <tr style="background: #e3f2fd; height: 50px">
                <th
                  style="
                    padding: 12px 8px;
                    border-bottom: 1px solid #eee;
                    text-align: center;
                    width: 15%;
                  "
                >
                  Mã lịch hẹn
                </th>
                <th
                  style="
                    padding: 12px 8px;
                    border-bottom: 1px solid #eee;
                    text-align: left;
                    width: 30%;
                  "
                >
                  Tên khách hàng
                </th>
                <th
                  style="
                    padding: 12px 8px;
                    border-bottom: 1px solid #eee;
                    text-align: center;
                    width: 35%;
                  "
                >
                  Mức độ hài lòng
                </th>
                <th
                  style="
                    padding: 12px 8px;
                    border-bottom: 1px solid #eee;
                    text-align: center;
                    width: 20%;
                  "
                >
                  Thao tác
                </th>
              </tr>
            </thead>
            <tbody id="appointmentTableBody">
              <!-- Dữ liệu sẽ được render bằng JS -->
            </tbody>
          </table>
        </div>
      </div>
      <script>
        // Danh sách dịch vụ mẫu (có loại)
        const serviceNames = [
          { id: 1, name: "Xét nghiệm ADN Cha - Con" },
          { id: 2, name: "Xét nghiệm ADN Mẹ - Con" },
          { id: 3, name: "Xét nghiệm ADN Anh/Chị - Em" },
          { id: 4, name: "Xét nghiệm ADN Ông/Bà - Cháu" },
        ];

        // Lưu trữ dữ liệu lịch hẹn từ API
        let appointmentsData = [];
        let currentPage = 0;
        let totalPages = 1;
        let pageSize = 15; // Tăng số lượng hiển thị trên mỗi trang
        // Lưu filter hiện tại
        let currentFilters = {
          status: "Hoàn thành", // Mặc định chỉ hiển thị lịch hẹn đã hoàn thành
          searchQuery: "",
        };

        // Function to render satisfaction level as stars
        function renderSatisfactionStars(rating) {
          if (!rating && rating !== 0)
            return "<div style='text-align: center; color: #666;'>Chưa có đánh giá</div>";

          const fullStars = Math.floor(rating);
          const hasHalfStar = rating % 1 >= 0.5;
          const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

          let starsHtml = "";

          // Add full stars
          for (let i = 0; i < fullStars; i++) {
            starsHtml += '<i class="fas fa-star" style="color: #ffc107;"></i>';
          }

          // Add half star if needed
          if (hasHalfStar) {
            starsHtml +=
              '<i class="fas fa-star-half-alt" style="color: #ffc107;"></i>';
          }

          // Add empty stars
          for (let i = 0; i < emptyStars; i++) {
            starsHtml += '<i class="far fa-star" style="color: #ffc107;"></i>';
          }

          return `<div style="display: flex; align-items: center; justify-content: center;">${starsHtml} <span style="color: #666; margin-left: 5px; font-size: 14px;">(${rating})</span></div>`;
        }

        // Function to calculate average satisfaction rating from services
        function calculateAverageSatisfaction(appointment) {
          if (!appointment.services || appointment.services.length === 0) {
            return null;
          }

          // Filter services that have satisfaction ratings
          const servicesWithRatings = appointment.services.filter(
            (service) =>
              service.satisfactionRating !== undefined &&
              service.satisfactionRating !== null
          );

          if (servicesWithRatings.length === 0) {
            return null;
          }

          // Calculate sum of all service ratings
          const sum = servicesWithRatings.reduce(
            (total, service) => total + (service.satisfactionRating || 0),
            0
          );

          // Calculate average with one decimal place
          return Math.round((sum / servicesWithRatings.length) * 10) / 10;
        }

        // Chế độ demo
        let isDemoMode = false;

        // Dữ liệu mẫu cho chế độ demo
        const demoAppointments = [
          {
            id: "AP006",
            customerName: "Ngô Thị F",
            method: "Tại cơ sở",
            bookingDate: "2025-06-30T00:00:00",
            status: "Hoàn thành",
            serviceId: 2,
            customerId: "CUS006",
            appointmentDateTime: "09:45",
            staffFullName: "Nhân viên Demo",
            note: "Đã liên hệ khách hàng nhận kết quả",
            services: [
              {
                serviceId: 2,
                name: "Xét nghiệm ADN Mẹ - Con",
                satisfactionRating: 5,
                comment: "Dịch vụ tuyệt vời, thời gian xử lý mẫu nhanh",
              },
              {
                serviceId: 1,
                name: "Xét nghiệm ADN Cha - Con",
                satisfactionRating: 5,
                comment: "Giá cả hợp lý, kết quả chính xác",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 5,
          },
          {
            id: "AP011",
            customerName: "Trương Văn L",
            method: "Tại nhà",
            bookingDate: "2025-06-23T00:00:00",
            status: "Hoàn thành",
            serviceId: 3,
            customerId: "CUS011",
            appointmentDateTime: "10:30",
            staffFullName: "Nhân viên Demo",
            note: "Đã gửi kết quả qua email cho khách",
            services: [
              {
                serviceId: 3,
                name: "Xét nghiệm ADN Anh/Chị - Em",
                satisfactionRating: 4.5,
                comment: "Nhân viên hỗ trợ tận tình, kết quả chính xác",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 4.5,
          },
          {
            id: "AP012",
            customerName: "Lý Thị M",
            method: "Tại cơ sở",
            bookingDate: "2025-06-20T00:00:00",
            status: "Hoàn thành",
            serviceId: 1,
            customerId: "CUS012",
            appointmentDateTime: "14:15",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng đã nhận kết quả trực tiếp",
            services: [
              {
                serviceId: 1,
                name: "Xét nghiệm ADN Cha - Con",
                satisfactionRating: 4,
                comment: "Thời gian lấy mẫu nhanh, nhân viên tư vấn tận tâm",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 4,
          },
          {
            id: "AP013",
            customerName: "Phan Văn N",
            method: "Tại nhà",
            bookingDate: "2025-06-18T00:00:00",
            status: "Hoàn thành",
            serviceId: 4,
            customerId: "CUS013",
            appointmentDateTime: "09:00",
            staffFullName: "Nhân viên Demo",
            note: "Kết quả đã được gửi qua bưu điện",
            services: [
              {
                serviceId: 4,
                name: "Xét nghiệm ADN Ông/Bà - Cháu",
                satisfactionRating: 5,
                comment:
                  "Dịch vụ lấy mẫu tại nhà rất tiện lợi, nhân viên đến đúng giờ",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 5,
          },
          {
            id: "AP014",
            customerName: "Hoàng Thị O",
            method: "Tại cơ sở",
            bookingDate: "2025-06-15T00:00:00",
            status: "Hoàn thành",
            serviceId: 2,
            customerId: "CUS014",
            appointmentDateTime: "16:30",
            staffFullName: "Nhân viên Demo",
            note: "Đã tư vấn thêm về các dịch vụ khác",
            services: [
              {
                serviceId: 2,
                name: "Xét nghiệm ADN Mẹ - Con",
                satisfactionRating: 3.5,
                comment: "Dịch vụ tốt nhưng thời gian chờ hơi lâu",
              },
              {
                serviceId: 3,
                name: "Xét nghiệm ADN Anh/Chị - Em",
                satisfactionRating: 4,
                comment: "Tư vấn chi tiết, đầy đủ thông tin",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 3.5,
          },
          {
            id: "AP015",
            customerName: "Trần Văn P",
            method: "Tại nhà",
            bookingDate: "2025-06-10T00:00:00",
            status: "Hoàn thành",
            serviceId: 1,
            customerId: "CUS015",
            appointmentDateTime: "11:45",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng cần kết quả gấp, đã xử lý ưu tiên",
            services: [
              {
                serviceId: 1,
                name: "Xét nghiệm ADN Cha - Con",
                satisfactionRating: 5,
                comment: "Xử lý nhanh theo yêu cầu gấp, rất hài lòng",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 5,
          },
          {
            id: "AP016",
            customerName: "Nguyễn Thị Q",
            method: "Tại cơ sở",
            bookingDate: "2025-06-08T00:00:00",
            status: "Hoàn thành",
            serviceId: 3,
            customerId: "CUS016",
            appointmentDateTime: "13:30",
            staffFullName: "Nhân viên Demo",
            note: "Cần bảo mật thông tin cao",
            services: [
              {
                serviceId: 3,
                name: "Xét nghiệm ADN Anh/Chị - Em",
                satisfactionRating: 4,
                comment: "Đảm bảo tính bảo mật cao, nhân viên chuyên nghiệp",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 4,
          },
          {
            id: "AP017",
            customerName: "Lê Văn R",
            method: "Tại nhà",
            bookingDate: "2025-06-05T00:00:00",
            status: "Hoàn thành",
            serviceId: 4,
            customerId: "CUS017",
            appointmentDateTime: "15:00",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng cao tuổi, cần hỗ trợ đặc biệt",
            services: [
              {
                serviceId: 4,
                name: "Xét nghiệm ADN Ông/Bà - Cháu",
                satisfactionRating: 5,
                comment:
                  "Nhân viên rất tận tình hỗ trợ người cao tuổi, rất hài lòng",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 5,
          },
          {
            id: "AP018",
            customerName: "Phạm Thị S",
            method: "Tại cơ sở",
            bookingDate: "2025-06-03T00:00:00",
            status: "Hoàn thành",
            serviceId: 2,
            customerId: "CUS018",
            appointmentDateTime: "09:15",
            staffFullName: "Nhân viên Demo",
            note: "Đã tư vấn thêm về quy trình pháp lý",
            services: [
              {
                serviceId: 2,
                name: "Xét nghiệm ADN Mẹ - Con",
                satisfactionRating: 4.5,
                comment:
                  "Tư vấn chi tiết và rõ ràng về các thủ tục pháp lý liên quan",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 4.5,
          },
          {
            id: "AP019",
            customerName: "Vũ Văn T",
            method: "Tại nhà",
            bookingDate: "2025-05-30T00:00:00",
            status: "Hoàn thành",
            serviceId: 1,
            customerId: "CUS019",
            appointmentDateTime: "14:45",
            staffFullName: "Nhân viên Demo",
            note: "Yêu cầu báo cáo chi tiết kèm theo kết quả",
            services: [
              {
                serviceId: 1,
                name: "Xét nghiệm ADN Cha - Con",
                satisfactionRating: 5,
                comment: "Báo cáo chi tiết, đầy đủ, dễ hiểu",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 5,
          },
          {
            id: "AP020",
            customerName: "Đặng Thị U",
            method: "Tại cơ sở",
            bookingDate: "2025-05-28T00:00:00",
            status: "Hoàn thành",
            serviceId: 3,
            customerId: "CUS020",
            appointmentDateTime: "10:45",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng từ nước ngoài, cần phiên dịch",
            services: [
              {
                serviceId: 3,
                name: "Xét nghiệm ADN Anh/Chị - Em",
                satisfactionRating: 4,
                comment:
                  "Nhân viên hỗ trợ tốt về ngôn ngữ, dịch vụ chuyên nghiệp",
              },
              {
                serviceId: 4,
                name: "Xét nghiệm ADN Ông/Bà - Cháu",
                satisfactionRating: 4.5,
                comment: "Kết quả chính xác, báo cáo đầy đủ bằng cả tiếng Anh",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 4,
          },
          {
            id: "AP001",
            customerName: "Nguyễn Văn A",
            method: "Tại nhà",
            bookingDate: "2025-07-05T00:00:00",
            status: "Đã đặt",
            serviceId: 1,
            customerId: "CUS001",
            appointmentDateTime: "09:00",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng muốn nhận kit vào buổi sáng",
            services: [
              {
                serviceId: 1,
                name: "Xét nghiệm ADN Cha - Con",
                satisfactionRating: 4.5,
                comment: "Dịch vụ rất tốt, nhân viên rất nhiệt tình hỗ trợ",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 4.5,
          },
          {
            id: "AP002",
            customerName: "Trần Thị B",
            method: "Tại cơ sở",
            bookingDate: "2025-07-06T00:00:00",
            status: "Chưa lấy mẫu",
            serviceId: 2,
            customerId: "CUS002",
            appointmentDateTime: "14:30",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng có dị ứng",
            services: [
              {
                serviceId: 2,
                name: "Xét nghiệm ADN Mẹ - Con",
                satisfactionRating: 5,
                comment: "Quy trình nhanh chóng, kết quả rõ ràng và chính xác",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 5,
          },
          {
            id: "AP003",
            customerName: "Lê Văn C",
            method: "Tại nhà",
            bookingDate: "2025-07-04T00:00:00",
            status: "Đã nhận kit",
            serviceId: 1,
            customerId: "CUS003",
            appointmentDateTime: "10:15",
            staffFullName: "Nhân viên Demo",
            note: "",
            services: [
              {
                serviceId: 1,
                name: "Xét nghiệm ADN Cha - Con",
                satisfactionRating: 3,
                comment: "Thời gian chờ hơi lâu, nhưng kết quả chính xác",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 3,
          },
          {
            id: "AP004",
            customerName: "Phạm Thị D",
            method: "Tại nhà",
            bookingDate: "2025-07-03T00:00:00",
            status: "Đã trả kit",
            serviceId: 3,
            customerId: "CUS004",
            appointmentDateTime: "15:45",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng cần kết quả gấp",
            services: [
              {
                serviceId: 3,
                name: "Xét nghiệm ADN Anh/Chị - Em",
                satisfactionRating: 4,
                comment: "Thái độ nhân viên tốt, dịch vụ chu đáo",
              },
              {
                serviceId: 4,
                name: "Xét nghiệm ADN Ông/Bà - Cháu",
                satisfactionRating: 3.5,
                comment: "Thời gian chờ hơi lâu, nhưng chất lượng dịch vụ tốt",
              },
            ],
            ADNService: "Hành chính",
            satisfactionRating: 4,
          },
          {
            id: "AP005",
            customerName: "Hoàng Văn E",
            method: "Tại cơ sở",
            bookingDate: "2025-07-01T00:00:00",
            status: "Hoàn thành lấy mẫu",
            serviceId: 4,
            customerId: "CUS005",
            appointmentDateTime: "11:30",
            staffFullName: "Nhân viên Demo",
            note: "",
            services: [
              {
                serviceId: 4,
                name: "Xét nghiệm ADN Ông/Bà - Cháu",
                satisfactionRating: 3.5,
                comment:
                  "Nhân viên tư vấn dịch vụ rất nhiệt tình và chuyên nghiệp",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 3.5,
          },
          {
            id: "AP007",
            customerName: "Đỗ Văn G",
            method: "Tại nhà",
            bookingDate: "2025-06-28T00:00:00",
            status: "Lỗi mẫu",
            serviceId: 1,
            customerId: "CUS007",
            appointmentDateTime: "16:00",
            staffFullName: "Nhân viên Demo",
            note: "Cần lấy lại mẫu, mẫu bị hỏng",
            services: [
              {
                serviceId: 1,
                name: "Xét nghiệm ADN Cha - Con",
                satisfactionRating: 2,
                comment:
                  "Thời gian chờ quá lâu, nhân viên tư vấn chưa nhiệt tình",
              },
              {
                serviceId: 3,
                name: "Xét nghiệm ADN Anh/Chị - Em",
                satisfactionRating: 3,
                comment: "Dịch vụ khá tốt nhưng cần cải thiện quy trình",
              },
            ],
            ADNService: "Tư pháp",
            satisfactionRating: 2,
          },
          {
            id: "AP008",
            customerName: "Vũ Thị H",
            method: "Tại cơ sở",
            bookingDate: "2025-07-08T00:00:00",
            status: "Chưa lấy mẫu",
            serviceId: 3,
            customerId: "CUS008",
            appointmentDateTime: "10:00",
            staffFullName: "Nhân viên Demo",
            note: "",
            services: [{ service: 3 }],
            ADNService: "Hành chính",
            satisfactionRating: null,
          },
          {
            id: "AP009",
            customerName: "Bùi Văn I",
            method: "Tại nhà",
            bookingDate: "2025-07-10T00:00:00",
            status: "Chưa nhận kit",
            serviceId: 4,
            customerId: "CUS009",
            appointmentDateTime: "13:15",
            staffFullName: "Nhân viên Demo",
            note: "Địa chỉ ở khu vực khó tìm",
            services: [{ service: 4 }],
            ADNService: "Tư pháp",
            satisfactionRating: null,
          },
          {
            id: "AP010",
            customerName: "Đinh Thị K",
            method: "Tại cơ sở",
            bookingDate: "2025-06-25T00:00:00",
            status: "Đã hủy",
            serviceId: 2,
            customerId: "CUS010",
            appointmentDateTime: "14:00",
            staffFullName: "Nhân viên Demo",
            note: "Khách hàng yêu cầu hủy vì bận việc đột xuất",
            services: [{ service: 2 }],
            ADNService: "Hành chính",
            satisfactionRating: 1.5,
          },
        ];

        // Hàm để lấy dữ liệu lịch hẹn từ server (có filter)
        async function fetchAppointments(page = 0, size = 15, filters = {}) {
          try {
            if (isDemoMode) {
              // Xử lý dữ liệu demo khi ở chế độ demo
              let filteredData = [...demoAppointments];

              // Chỉ hiển thị các lịch hẹn có trạng thái "Hoàn thành"
              filteredData = filteredData.filter(
                (item) => item.status === "Hoàn thành"
              );

              // Áp dụng bộ lọc tìm kiếm
              if (filters.searchQuery) {
                const query = filters.searchQuery.toLowerCase();
                filteredData = filteredData.filter(
                  (item) =>
                    item.id.toLowerCase().includes(query) ||
                    item.customerName.toLowerCase().includes(query)
                );
              }

              // Phân trang
              const total = filteredData.length;
              const start = page * size;
              const end = Math.min(start + size, total);
              const paginatedData = filteredData.slice(start, end);

              appointmentsData = paginatedData;
              currentPage = page;
              totalPages = Math.ceil(total / size);
              pageSize = size;

              renderAppointments(appointmentsData);
              renderPagination();
              return {
                content: appointmentsData,
                page: currentPage,
                totalPages,
                size,
              };
            } else {
              // Xử lý dữ liệu thật từ API khi không ở chế độ demo
              // Build query string
              let params = new URLSearchParams();
              params.append("page", page);
              params.append("size", size);

              // Chỉ hiển thị các lịch hẹn có trạng thái "Hoàn thành"
              params.append("status", "Hoàn thành");

              // Áp dụng bộ lọc tìm kiếm
              if (filters.searchQuery)
                params.append("searchQuery", filters.searchQuery);

              const response = await fetch(
                `/booking/staff/appointments?${params.toString()}`,
                {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  credentials: "include", // Để gửi cookie
                }
              );

              if (response.status === 401) {
                window.location.href = "/internal-login";
                return;
              }

              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();
              appointmentsData = data.content;
              currentPage = data.page;
              totalPages = data.totalPages;
              pageSize = data.size;
              renderAppointments(appointmentsData);
              renderPagination();
              return data;
            }
          } catch (error) {
            console.error("Lỗi khi lấy dữ liệu lịch hẹn:", error);
            renderAppointments([]);
            renderPagination();
          }
        }

        // Sửa renderPagination để truyền filter khi chuyển trang
        function renderPagination() {
          const containerId = "pagination-container";
          let container = document.getElementById(containerId);
          if (!container) {
            container = document.createElement("div");
            container.id = containerId;
            container.style =
              "display:flex;justify-content:center;align-items:center;margin:20px 0;gap:8px;";
            document.querySelector(".main-content").appendChild(container);
          }
          container.innerHTML = "";
          if (totalPages <= 1) return;
          // Nút prev
          const prevBtn = document.createElement("button");
          prevBtn.innerText = "«";
          prevBtn.className = "btn btn-primary";
          prevBtn.disabled = currentPage === 0;
          prevBtn.onclick = () =>
            fetchAppointments(currentPage - 1, pageSize, currentFilters);
          container.appendChild(prevBtn);
          // Số trang
          for (let i = 0; i < totalPages; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.innerText = i + 1;
            pageBtn.className =
              "btn" + (i === currentPage ? " btn-success" : " btn-primary");
            pageBtn.disabled = i === currentPage;
            pageBtn.onclick = () =>
              fetchAppointments(i, pageSize, currentFilters);
            container.appendChild(pageBtn);
          }
          // Nút next
          const nextBtn = document.createElement("button");
          nextBtn.innerText = "»";
          nextBtn.className = "btn btn-primary";
          nextBtn.disabled = currentPage === totalPages - 1;
          nextBtn.onclick = () =>
            fetchAppointments(currentPage + 1, pageSize, currentFilters);
          container.appendChild(nextBtn);
        }

        // Cập nhật hàm renderStatus để sử dụng badge styles
        function renderStatus(status) {
          let className = "";
          switch (status) {
            case "Đã đặt":
              className = "status-booked";
              break;
            // Flow Tại nhà
            case "Chưa nhận kit":
              className = "status-kit-pending";
              break;
            case "Đã nhận kit":
              className = "status-kit-received";
              break;
            case "Đã trả kit":
              className = "status-kit-returned";
              break;
            // Flow Tại cơ sở
            case "Chưa lấy mẫu":
              className = "status-not-sampled";
              break;
            // Chung cho cả 2 flow
            case "Hoàn thành lấy mẫu":
              className = "status-sampling-completed";
              break;
            case "Lỗi mẫu":
              className = "status-sample-error";
              break;
            case "Hoàn thành":
              className = "status-final-completed";
              break;
            case "Đã hủy":
              className = "status-cancelled";
              break;
            // Trạng thái cũ (backwards compatibility)
            case "Đang chờ lấy mẫu":
              className = "status-waiting";
              break;
            case "Đã nhận mẫu":
              className = "status-received";
              break;
            case "Đã hoàn thành":
              className = "status-completed";
              break;
            default:
              className = "status-booked";
          }
          return `<span class="status-badge ${className}"><i class="fas fa-circle" style="font-size: 8px"></i> ${status}</span>`;
        }

        // Cập nhật hàm render bảng
        function renderAppointments(data) {
          const tbody = document.getElementById("appointmentTableBody");
          tbody.innerHTML = data.length
            ? data
                .map((a, index) => {
                  // Calculate the average satisfaction rating from all services
                  const avgRating = calculateAverageSatisfaction(a);

                  return `
            <tr style="border-bottom: 1px solid #eee; ${
              index % 2 === 0 ? "background-color: #f9f9f9;" : ""
            }">
              <td style="text-align: center; vertical-align: middle; padding: 12px 8px;">${
                a.id
              }</td>
              <td style="vertical-align: middle; padding: 12px 8px;">${
                a.customerName
              }</td>
              <td style="text-align: center; vertical-align: middle; padding: 12px 8px;">${renderSatisfactionStars(
                avgRating
              )}</td>
              <td style="text-align: center; vertical-align: middle; padding: 12px 8px;">
                <button onclick="viewAppointmentDetails('${
                  a.id
                }')" class="btn btn-primary" style="background:#e3f2fd;color:#1976d2;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
                  <i class="fas fa-info-circle"></i> Xem
                </button>
              </td>
            </tr>
          `;
                })
                .join("")
            : `<tr><td colspan="4" style="text-align:center; color:#888; padding:20px;">Không có lịch hẹn phù hợp</td></tr>`;
        }

        // Hàm render các nút action dựa trên trạng thái
        function renderActionButtons(appointment) {
          let buttons = "";

          // Nút cập nhật trạng thái cho hầu hết các trạng thái
          if (
            appointment.status !== "Hoàn thành" &&
            appointment.status !== "Đã hủy"
          ) {
            buttons += `
              <button onclick="openQuickStatusModal('${appointment.id}', '${appointment.status}')" class="btn btn-success" style="background:#e8f5e9;color:#388e3c;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-sync-alt"></i> Cập nhật trạng thái
              </button>
            `;
          }

          // Nút "Xác nhận" cho các trạng thái cụ thể
          if (appointment.status === "Đã đặt") {
            // Xác nhận chuyển sang trạng thái tiếp theo dựa trên phương thức
            const nextStatus =
              appointment.method === "Tại nhà"
                ? "Chưa nhận kit"
                : "Chưa lấy mẫu";
            buttons += `
              <button onclick="confirmStatusChange('${appointment.id}', '${nextStatus}')" class="btn" style="background:#ff9800;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-check"></i> Xác nhận
              </button>
            `;
          } else if (appointment.status === "Chưa lấy mẫu") {
            // Xác nhận đã lấy mẫu
            buttons += `
              <button onclick="confirmStatusChange('${appointment.id}', 'Hoàn thành lấy mẫu')" class="btn" style="background:#ff9800;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-check"></i> Xác nhận
              </button>
            `;
          }

          return buttons;
        }

        // Hàm xác nhận thay đổi trạng thái nhanh
        async function confirmStatusChange(bookingId, newStatus) {
          const confirmation = confirm(
            `Bạn có chắc chắn muốn chuyển trạng thái sang "${newStatus}"?`
          );

          if (!confirmation) {
            return;
          }

          try {
            if (isDemoMode) {
              // Xử lý cập nhật trạng thái trong chế độ demo
              const index = appointmentsData.findIndex(
                (item) => item.id === bookingId
              );
              if (index !== -1) {
                appointmentsData[index].status = newStatus;

                // Cập nhật trạng thái trong demoAppointments để lưu giữ khi chuyển trang
                const demoIndex = demoAppointments.findIndex(
                  (item) => item.id === bookingId
                );
                if (demoIndex !== -1) {
                  demoAppointments[demoIndex].status = newStatus;
                }

                showSuccessToast(
                  `[DEMO] Đã cập nhật trạng thái thành "${newStatus}" thành công!`
                );
                renderAppointments(appointmentsData);
              }
            } else {
              // Xử lý cập nhật trạng thái thực tế
              const response = await fetch(
                `/booking/staff/appointments/${bookingId}/status`,
                {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include",
                  body: JSON.stringify({ status: newStatus }),
                }
              );

              if (response.status === 401) {
                window.location.href = "/internal-login";
                return;
              }

              if (!response.ok) {
                throw new Error(await response.text());
              }

              showSuccessToast(
                `Đã cập nhật trạng thái thành "${newStatus}" thành công!`
              );
              fetchAppointments(currentPage, pageSize, currentFilters);
            }
          } catch (error) {
            console.error("Lỗi khi cập nhật trạng thái:", error);
            alert("Có lỗi xảy ra khi cập nhật trạng thái: " + error.message);
          }
        }

        // Xử lý filter: chỉ tìm kiếm theo từ khóa nhập vào
        document
          .getElementById("filterForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const searchQuery = document.getElementById("searchFilter").value;

            currentFilters = {
              status: "Hoàn thành", // Luôn lọc theo trạng thái "Hoàn thành"
              searchQuery,
            };
            fetchAppointments(0, pageSize, currentFilters);
          });

        // Hiển thị thông báo thành công
        function showSuccessToast(message) {
          const toast = document.createElement("div");
          toast.className = "toast-notification";
          toast.innerHTML = `
            <div class="toast-content">
              <i class="fas fa-check-circle" style="color: #4caf50; margin-right: 8px;"></i>
              ${message}
            </div>
          `;
          document.body.appendChild(toast);

          // Tự động ẩn toast sau 3 giây
          setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        // Thêm style cho toast notification
        const style = document.createElement("style");
        style.textContent = `
          .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            z-index: 1000;
          }

          .toast-content {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #333;
          }

          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }

          @keyframes fadeOut {
            from {
              opacity: 1;
            }
            to {
              opacity: 0;
            }
          }

          .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
          }

          .status-booked {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196f3;
          }

          .status-waiting {
            background-color: rgba(255, 152, 0, 0.1);
            color: #ff9800;
          }

          .status-received {
            background-color: rgba(25, 118, 210, 0.1);
            color: #1976d2;
          }

          .status-completed {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
          }

          .status-delivered {
            background-color: rgba(0, 150, 136, 0.1);
            color: #009688;
          }

          .status-cancelled {
            background-color: rgba(244, 67, 54, 0.1);
            color: #f44336;
          }

          /* CSS cho các trạng thái mới */
          .status-kit-pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
          }

          .status-kit-received {
            background-color: rgba(156, 39, 176, 0.1);
            color: #9c27b0;
          }

          .status-kit-returned {
            background-color: rgba(63, 81, 181, 0.1);
            color: #3f51b5;
          }

          .status-not-sampled {
            background-color: rgba(3, 169, 244, 0.1);
            color: #03a9f4;
          }

          .status-sampling-completed {
            background-color: rgba(139, 195, 74, 0.1);
            color: #8bc34a;
          }

          .status-sample-error {
            background-color: rgba(255, 87, 34, 0.1);
            color: #ff5722;
          }

          .status-final-completed {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
          }

          .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
            cursor: pointer;
          }

          .btn-primary {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            color: white;
          }

          .btn-success {
            background: linear-gradient(45deg, #4caf50, #388e3c);
            color: white;
          }
        `;
        document.head.appendChild(style);

        // Render mặc định khi load trang
        document.addEventListener("DOMContentLoaded", function () {
          // Khởi tạo nút chuyển đổi chế độ demo
          const toggleButton = document.getElementById("toggleDemoMode");
          const statusText = document.getElementById("demoModeStatus");

          toggleButton.addEventListener("click", function () {
            isDemoMode = !isDemoMode;

            // Cập nhật trạng thái UI
            if (isDemoMode) {
              toggleButton.innerHTML =
                '<i class="fas fa-database"></i> Chế độ thực';
              toggleButton.style.background = "#4caf50";
              statusText.style.display = "inline";
            } else {
              toggleButton.innerHTML =
                '<i class="fas fa-flask"></i> Chế độ demo';
              toggleButton.style.background = "#ff9800";
              statusText.style.display = "none";
            }

            // Làm mới dữ liệu
            resetFilter();
          });

          fetchAppointments();
        });

        // Hàm reset filter
        function resetFilter() {
          document.getElementById("filterForm").reset();
          currentFilters = {
            status: "Hoàn thành", // Luôn lọc theo trạng thái "Hoàn thành"
            searchQuery: "",
          };
          fetchAppointments(0, pageSize, currentFilters);
        }
      </script>
    </div>

    <!-- Phần code ở đây -->

    <script>
      // Modal HTML cho chỉnh sửa lịch hẹn
      const editAppointmentModalHtml = `  <div id="edit-appointment-modal" style="
  display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;
  background:rgba(30,42,60,0.35);backdrop-filter:blur(2px);
  justify-content:center;align-items:center;transition:background 0.3s;overflow:auto;">
  <div style="
    background:#fff;border-radius:18px;max-width:80vw;width:95vw;
    box-shadow:0 8px 32px rgba(0,0,0,0.18),0 1.5px 8px rgba(33,150,243,0.08);
    padding:0;position:relative;overflow:auto;animation:modalFadeIn 0.35s;
    margin:30px auto;">
    <button id="edit-appointment-close" style="
      position:absolute;top:12px;right:18px;background:rgba(33,150,243,0.08);
      border:none;font-size:26px;cursor:pointer;color:#2196f3;
      border-radius:50%;width:36px;height:36px;transition:background 0.2s;
      z-index:10001;">
      &times;
    </button>
    <iframe id="edit-appointment-iframe" src="" style="
      width:100%;height:85vh;border:none;display:block;
      border-radius:18px;overflow:auto;background:transparent;" scrolling="auto"></iframe>
  </div>
</div>
  <style>
    @keyframes modalFadeIn {
      from { transform: translateY(40px) scale(0.97); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
    #edit-appointment-modal::-webkit-scrollbar,
    #edit-appointment-modal > div::-webkit-scrollbar { display: none; }
    #edit-appointment-modal, #edit-appointment-modal > div { scrollbar-width: none; }
    #edit-appointment-close:hover { background:rgba(33,150,243,0.18);}
    
    /* Thêm media query cho modal chỉnh sửa */
    @media (max-width: 768px) {
      #edit-appointment-modal > div {
        max-width: 95vw;
        margin: 20px auto;
      }
      #edit-appointment-iframe {
        height: 80vh;
      }
    }
  </style>
`;
      if (!document.getElementById("edit-appointment-modal")) {
        document.body.insertAdjacentHTML("beforeend", editAppointmentModalHtml);
        document.getElementById("edit-appointment-close").onclick = function (
          e
        ) {
          // Ngăn chặn sự kiện mặc định để tránh redirect
          if (e && e.preventDefault) e.preventDefault();
          if (e && e.stopPropagation) e.stopPropagation();

          // Xóa src trước khi ẩn modal để tránh các redirect từ frame
          const iframe = document.getElementById("edit-appointment-iframe");
          iframe.src = "about:blank";

          // Ẩn modal
          document.getElementById("edit-appointment-modal").style.display =
            "none";

          // Trả về false để ngăn chặn các hành vi mặc định khác
          return false;
        };

        document.getElementById("edit-appointment-modal").onclick = function (
          e
        ) {
          if (e.target === this) {
            // Ngăn chặn sự kiện mặc định và lan truyền
            if (e && e.preventDefault) e.preventDefault();
            if (e && e.stopPropagation) e.stopPropagation();

            // Xóa src trước khi ẩn modal
            const iframe = document.getElementById("edit-appointment-iframe");
            iframe.src = "about:blank";

            // Ẩn modal
            this.style.display = "none";

            return false;
          }
        };
      }
    </script>
    <!-- Include the auth and API JS files -->
    <script src="/assets/js/staff-api.js"></script>
    <script src="/assets/js/staff-auth.js"></script>
    <script src="/assets/js/staff-main.js"></script>

    <!-- Modal HTML cho chi tiết lịch hẹn -->
    <div
      id="appointment-details-modal"
      style="
        display: none;
        position: fixed;
        z-index: 10000;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(30, 42, 60, 0.5);
        backdrop-filter: blur(3px);
        justify-content: center;
        align-items: center;
        transition: background 0.3s;
        overflow: auto;
      "
    >
      <div
        class="appointment-details-container"
        style="
          background: white;
          border-radius: 15px;
          box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
          padding: 30px;
          width: 100%;
          max-width: 800px;
          margin: 20px auto;
          animation: modalFadeIn 0.4s ease-out;
        "
      >
        <div
          class="details-header"
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
          "
        >
          <div class="header-left" style="display: flex; align-items: center">
            <img
              src="/assets/images/logo.png"
              alt="GenX Logo"
              class="logo"
              style="width: 40px; height: 40px; margin-right: 15px"
            />
            <div
              class="header-title"
              style="font-size: 24px; font-weight: bold; color: #2196f3"
            >
              Chi Tiết Lịch Hẹn
            </div>
          </div>

          <div
            class="appointment-badge"
            id="modal-appointment-id"
            style="
              background-color: #e3f2fd;
              color: #2196f3;
              padding: 8px 15px;
              border-radius: 20px;
              font-weight: 500;
              font-size: 14px;
            "
          >
            Mã:
          </div>

          <button
            id="appointment-details-close"
            style="
              background: rgba(33, 150, 243, 0.08);
              border: none;
              font-size: 22px;
              cursor: pointer;
              color: #2196f3;
              border-radius: 50%;
              width: 36px;
              height: 36px;
              transition: background 0.2s;
              margin-left: 15px;
            "
          ></button>
        </div>

        <div class="details-section" style="margin-bottom: 25px">
          <h2
            class="section-title"
            style="
              font-size: 18px;
              color: #333;
              margin-bottom: 15px;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
              display: flex;
              align-items: center;
            "
          >
            <i class="fas fa-user" style="margin-right: 10px"></i> Thông Tin
            Khách Hàng
          </h2>
          <div
            class="info-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
              gap: 15px;
            "
          >
            <div class="info-item" style="margin-bottom: 15px">
              <div
                class="info-label"
                style="font-size: 14px; color: #777; margin-bottom: 5px"
              >
                Mã Khách Hàng
              </div>
              <div
                class="info-value"
                id="modal-customer-id"
                style="font-weight: 500; color: #333"
              ></div>
            </div>
            <div class="info-item" style="margin-bottom: 15px">
              <div
                class="info-label"
                style="font-size: 14px; color: #777; margin-bottom: 5px"
              >
                Tên Khách Hàng
              </div>
              <div
                class="info-value"
                id="modal-customer-name"
                style="font-weight: 500; color: #333"
              ></div>
            </div>
          </div>
        </div>

        <div class="details-section" style="margin-bottom: 25px">
          <h2
            class="section-title"
            style="
              font-size: 18px;
              color: #333;
              margin-bottom: 15px;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
              display: flex;
              align-items: center;
            "
          >
            <i class="fas fa-calendar-alt" style="margin-right: 10px"></i> Thông
            Tin Lịch Hẹn
          </h2>
          <div
            class="info-grid"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
              gap: 15px;
            "
          >
            <div class="info-item" style="margin-bottom: 15px">
              <div
                class="info-label"
                style="font-size: 14px; color: #777; margin-bottom: 5px"
              >
                Ngày Hẹn
              </div>
              <div
                class="info-value"
                id="modal-appointment-date"
                style="font-weight: 500; color: #333"
              ></div>
            </div>
            <div class="info-item" style="margin-bottom: 15px">
              <div
                class="info-label"
                style="font-size: 14px; color: #777; margin-bottom: 5px"
              >
                Giờ Hẹn
              </div>
              <div
                class="info-value"
                id="modal-appointment-time"
                style="font-weight: 500; color: #333"
              ></div>
            </div>
            <div class="info-item" style="margin-bottom: 15px">
              <div
                class="info-label"
                style="font-size: 14px; color: #777; margin-bottom: 5px"
              >
                Phương Thức Lấy Mẫu
              </div>
              <div
                class="info-value"
                id="modal-collection-method"
                style="font-weight: 500; color: #333"
              ></div>
            </div>
            <div class="info-item" style="margin-bottom: 15px">
              <div
                class="info-label"
                style="font-size: 14px; color: #777; margin-bottom: 5px"
              >
                Nhân Viên Phụ TráchTrách
              </div>
              <div
                class="info-value"
                id="modal-staff-name"
                style="font-weight: 500; color: #333"
              ></div>
            </div>
            <div class="info-item" style="margin-bottom: 15px">
              <div
                class="info-label"
                style="font-size: 14px; color: #777; margin-bottom: 5px"
              >
                Trạng Thái
              </div>
              <div
                class="status-badge"
                id="modal-status-badge"
                style="
                  display: inline-block;
                  padding: 6px 12px;
                  border-radius: 15px;
                  font-size: 14px;
                  font-weight: 500;
                  background: #ffecb3;
                  color: #ff9800;
                "
              ></div>
            </div>
          </div>
        </div>

        <div class="details-section" style="margin-bottom: 25px">
          <h2
            class="section-title"
            style="
              font-size: 18px;
              color: #333;
              margin-bottom: 15px;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
              display: flex;
              align-items: center;
            "
          >
            <i class="fas fa-flask" style="margin-right: 10px"></i> Dịch Vụ Xét
            Nghiệm
          </h2>
          <ul
            class="services-list"
            id="modal-services-list"
            style="list-style: none; padding: 0"
          >
            <!-- Dịch vụ sẽ được thêm bằng JavaScript -->
          </ul>
        </div>

        <div class="details-section" style="margin-bottom: 25px">
          <h2
            class="section-title"
            style="
              font-size: 18px;
              color: #333;
              margin-bottom: 15px;
              padding-bottom: 10px;
              border-bottom: 1px solid #eee;
              display: flex;
              align-items: center;
            "
          >
            <i class="fas fa-clipboard" style="margin-right: 10px"></i> Ghi Chú
          </h2>
          <div class="info-item">
            <div
              class="info-value"
              id="modal-notes"
              style="color: #555; line-height: 1.5"
            ></div>
          </div>
        </div>

        <!-- Thêm nút hủy lịch hẹn -->
        <div
          id="cancel-appointment-section"
          style="
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            display: none;
          "
        >
          <div style="display: flex; justify-content: flex-end; gap: 10px">
            <button
              id="cancel-appointment-btn"
              onclick="handleCancelAppointment()"
              style="
                background: #dc3545;
                color: white;
                border: none;
                border-radius: 6px;
                padding: 10px 20px;
                cursor: pointer;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.3s ease;
              "
            >
              <i class="fas fa-times"></i>
              Hủy lịch hẹn
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Hàm hiển thị modal chi tiết lịch hẹn
      function viewAppointmentDetails(id) {
        // Truy vấn dữ liệu lịch hẹn từ danh sách
        const appointment = appointmentsData.find((a) => a.id == id);
        if (!appointment) {
          alert("Không tìm thấy thông tin lịch hẹn!");
          return;
        }

        // Hiển thị các thông tin vào modal
        document.getElementById(
          "modal-appointment-id"
        ).textContent = `Mã: ${appointment.id}`;
        document.getElementById("modal-customer-id").textContent =
          appointment.customerId || "Không có";
        document.getElementById("modal-customer-name").textContent =
          appointment.customerName;

        // Định dạng ngày
        if (appointment.bookingDate) {
          const date = new Date(appointment.bookingDate);
          document.getElementById("modal-appointment-date").textContent =
            date.toLocaleDateString("vi-VN");
        }

        document.getElementById("modal-appointment-time").textContent =
          appointment.appointmentDateTime || "Không có";
        document.getElementById("modal-collection-method").textContent =
          appointment.method;
        document.getElementById("modal-staff-name").textContent =
          appointment.staffFullName || "Chưa phân công";
        document.getElementById("modal-notes").textContent =
          appointment.note || "Không có ghi chú";

        // Hiển thị trạng thái
        const statusBadge = document.getElementById("modal-status-badge");
        statusBadge.textContent = appointment.status;

        // Thiết lập màu cho trạng thái
        let statusColor = "#888";
        let statusBg = "#eee";

        if (appointment.status === "Đã đặt") {
          statusColor = "#ff9800";
          statusBg = "#ffecb3";
        } else if (appointment.status === "Đang chờ lấy mẫu") {
          statusColor = "#1976d2";
          statusBg = "#e3f2fd";
        } else if (appointment.status === "Đã nhận mẫu") {
          statusColor = "#00bcd4";
          statusBg = "#e0f7fa";
        } else if (appointment.status === "Đã hoàn thành") {
          statusColor = "#4caf50";
          statusBg = "#e8f5e9";
        } else if (appointment.status === "Đã hủy") {
          statusColor = "#f44336";
          statusBg = "#ffebee";
        }

        statusBadge.style.color = statusColor;
        statusBadge.style.backgroundColor = statusBg;

        // Hiển thị dịch vụ
        const servicesList = document.getElementById("modal-services-list");
        servicesList.innerHTML = ""; // Xóa nội dung cũ

        if (appointment.services && appointment.services.length > 0) {
          appointment.services.forEach((service) => {
            const li = document.createElement("li");
            li.style.padding = "10px 15px";
            li.style.borderRadius = "8px";
            li.style.backgroundColor = "#f5f5f5";
            li.style.marginBottom = "8px";
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.alignItems = "center";

            // Tạo tên dịch vụ và loại
            const serviceName = document.createElement("div");
            serviceName.style.display = "flex";
            serviceName.style.alignItems = "center";

            const icon = document.createElement("i");
            icon.className = "fas fa-dna";
            icon.style.marginRight = "10px";
            icon.style.color = "#2196f3";

            serviceName.appendChild(icon);
            serviceName.appendChild(
              document.createTextNode(getServiceDisplayName(service.service))
            );

            // Tạo badge cho mục đích
            const purposeBadge = document.createElement("span");
            purposeBadge.textContent = appointment.ADNService;
            purposeBadge.style.padding = "4px 10px";
            purposeBadge.style.borderRadius = "12px";
            purposeBadge.style.fontSize = "12px";
            purposeBadge.style.fontWeight = "500";

            if (appointment.ADNService === "Hành chính") {
              purposeBadge.style.backgroundColor = "#e8f5e9";
              purposeBadge.style.color = "#4caf50";
            } else {
              purposeBadge.style.backgroundColor = "#e3f2fd";
              purposeBadge.style.color = "#1976d2";
            }

            li.appendChild(serviceName);
            li.appendChild(purposeBadge);

            servicesList.appendChild(li);
          });
        } else {
          const li = document.createElement("li");
          li.style.padding = "10px";
          li.style.color = "#888";
          li.textContent = "Không có dịch vụ";
          servicesList.appendChild(li);
        }

        // Hiển thị modal
        document.getElementById("appointment-details-modal").style.display =
          "flex";

        // Hiển thị nút hủy lịch hẹn nếu trạng thái cho phép
        const cancelSection = document.getElementById(
          "cancel-appointment-section"
        );
        if (
          appointment.status === "Đã đặt" ||
          appointment.status === "Đang chờ lấy mẫu" ||
          appointment.status === "Đã nhận mẫu" ||
          appointment.status === "Đã hoàn thành"
        ) {
          cancelSection.style.display = "block";
          // Lưu ID lịch hẹn để sử dụng khi hủy
          cancelSection.setAttribute("data-appointment-id", appointment.id);
        } else {
          cancelSection.style.display = "none";
        }
      }

      // Hàm chuyển đổi tên dịch vụ
      function getServiceDisplayName(service) {
        switch (service) {
          case "ADN cha-con":
            return "Xét nghiệm ADN cha-con";
          case "ADN mẹ-con":
            return "Xét nghiệm ADN mẹ-con";
          case "ADN anh,chi-em":
            return "Xét nghiệm ADN anh,chị-em";
          case "ADN ông,bà-cháu":
            return "Xét nghiệm ADN ông, bà - cháu";
          case "ADN họ hàng":
            return "Xét nghiệm ADN họ hàng";
          default:
            return service;
        }
      }

      // Khởi tạo modal chi tiết lịch hẹn
      document.addEventListener("DOMContentLoaded", function () {
        // Thêm sự kiện đóng modal khi nhấp vào nút đóng
        document
          .getElementById("appointment-details-close")
          .addEventListener("click", function () {
            document.getElementById("appointment-details-modal").style.display =
              "none";
          });

        // Thêm sự kiện đóng modal khi nhấp vào nền
        document
          .getElementById("appointment-details-modal")
          .addEventListener("click", function (e) {
            if (e.target === this) {
              this.style.display = "none";
            }
          });
      });

      // Hàm xử lý hủy lịch hẹn
      function handleCancelAppointment() {
        const cancelSection = document.getElementById(
          "cancel-appointment-section"
        );
        const appointmentId = cancelSection.getAttribute("data-appointment-id");

        if (!appointmentId) {
          alert("Không tìm thấy thông tin lịch hẹn!");
          return;
        }

        // Hiển thị modal chọn lý do hủy
        showCancelReasonModal(appointmentId);
      }

      // Hàm hiển thị modal chọn lý do hủy
      function showCancelReasonModal(appointmentId) {
        const modal = document.createElement("div");
        modal.className = "cancel-reason-modal";
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(2px);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10002;
        `;

        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
          ">
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
              padding-bottom: 15px;
              border-bottom: 1px solid #eee;
            ">
              <h3 style="margin: 0; color: #333; font-size: 18px;">
                <i class="fas fa-exclamation-triangle" style="color: #dc3545; margin-right: 8px;"></i>
                Lý do hủy lịch hẹn
              </h3>
              <button onclick="this.closest('.cancel-reason-modal').remove()" style="
                background: none;
                border: none;
                font-size: 24px;
                cursor: pointer;
                color: #666;
                padding: 0;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">&times;</button>
            </div>

            <form id="cancel-reason-form">
              <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="cancel-reason" value="Thay đổi thông tin/địa chỉ" style="margin-right: 10px;">
                  <span>Thay đổi thông tin/địa chỉ</span>
                </label>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="cancel-reason" value="Khách hàng yêu cầu hủy" style="margin-right: 10px;">
                  <span>Khách hàng yêu cầu hủy</span>
                </label>
              </div>

              <div style="margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                  <input type="radio" name="cancel-reason" value="Khác" style="margin-right: 10px;">
                  <span>Khác</span>
                </label>
              </div>

              <div id="other-reason-container" style="display: none; margin-bottom: 20px;">
                <textarea 
                  id="other-reason-text"
                  placeholder="Vui lòng nhập lý do cụ thể..."
                  style="
                    width: 100%;
                    min-height: 80px;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 6px;
                    resize: vertical;
                    font-family: inherit;
                  "
                ></textarea>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button type="button" onclick="this.closest('.cancel-reason-modal').remove()" style="
                  background: #f5f5f5;
                  color: #333;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  padding: 10px 20px;
                  cursor: pointer;
                ">
                  Hủy bỏ
                </button>
                <button type="submit" style="
                  background: #dc3545;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  padding: 10px 20px;
                  cursor: pointer;
                ">
                  Xác nhận hủy
                </button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(modal);

        // Xử lý hiển thị textarea khi chọn "Khác"
        const reasonRadios = modal.querySelectorAll(
          'input[name="cancel-reason"]'
        );
        const otherReasonContainer = modal.querySelector(
          "#other-reason-container"
        );

        reasonRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            if (this.value === "Khác") {
              otherReasonContainer.style.display = "block";
            } else {
              otherReasonContainer.style.display = "none";
            }
          });
        });

        // Xử lý submit form
        const form = modal.querySelector("#cancel-reason-form");
        form.addEventListener("submit", function (e) {
          e.preventDefault();
          confirmCancelAppointment(appointmentId, modal);
        });

        // Đóng modal khi click ra ngoài
        modal.addEventListener("click", function (e) {
          if (e.target === this) {
            this.remove();
          }
        });
      }

      // Hàm xác nhận hủy lịch hẹn
      async function confirmCancelAppointment(appointmentId, reasonModal) {
        const selectedReason = document.querySelector(
          'input[name="cancel-reason"]:checked'
        );

        if (!selectedReason) {
          alert("Vui lòng chọn lý do hủy lịch hẹn");
          return;
        }

        let reason = selectedReason.value;
        if (reason === "Khác") {
          const otherReasonText = document
            .getElementById("other-reason-text")
            .value.trim();
          if (!otherReasonText) {
            alert("Vui lòng nhập lý do cụ thể");
            return;
          }
          reason = otherReasonText;
        }

        try {
          // Gọi API giống customer
          const response = await fetch(
            `/booking/cancel?bookingId=${appointmentId}&reason=${encodeURIComponent(
              reason
            )}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              credentials: "include",
            }
          );

          if (response.status === 401) {
            window.location.href = "/internal-login";
            return;
          }

          if (!response.ok) {
            throw new Error(await response.text());
          }

          // Đóng modal lý do hủy
          reasonModal.remove();

          // Đóng modal chi tiết lịch hẹn
          document.getElementById("appointment-details-modal").style.display =
            "none";

          // Hiển thị thông báo thành công
          showSuccessToast("Đã hủy lịch hẹn thành công!");

          // Tải lại dữ liệu
          fetchAppointments(currentPage, pageSize, currentFilters);
        } catch (error) {
          console.error("Lỗi khi hủy lịch hẹn:", error);
          alert("Có lỗi xảy ra khi hủy lịch hẹn: " + error.message);
        }
      }
    </script>
    <script>
      // Đảm bảo có hàm openEditAppointmentModal để mở editappointment.html trong modal/iframe
      function openEditAppointmentModal(appointmentId) {
        // Giả sử đã có modal/iframe edit-appointment-modal như trước
        const modal = document.getElementById("edit-appointment-modal");
        const iframe = document.getElementById("edit-appointment-iframe");
        if (modal && iframe) {
          iframe.src = `/edit-appointment?appointmentId=${appointmentId}`;
          modal.style.display = "flex";
        } else {
          // Nếu không có modal, chuyển trang trực tiếp
          window.location.href = `/edit-appointment?appointmentId=${appointmentId}`;
        }
      }
    </script>

    <!-- Modal cập nhật trạng thái nhanh -->
    <div
      id="quick-status-modal"
      style="
        display: none;
        position: fixed;
        z-index: 10001;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(30, 42, 60, 0.35);
        backdrop-filter: blur(2px);
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: #fff;
          border-radius: 12px;
          min-width: 320px;
          max-width: 95vw;
          padding: 24px 20px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
          position: relative;
        "
      >
        <button
          id="quick-status-close"
          style="
            position: absolute;
            top: 10px;
            right: 14px;
            background: rgba(33, 150, 243, 0.08);
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: #2196f3;
            border-radius: 50%;
            width: 32px;
            height: 32px;
          "
        >
          &times;
        </button>
        <h3 style="margin-bottom: 18px; font-size: 18px; color: #2196f3">
          Cập nhật trạng thái lịch hẹn
        </h3>
        <form id="quick-status-form">
          <input type="hidden" id="quick-status-booking-id" />
          <div style="margin-bottom: 16px">
            <label for="quick-status-select" style="font-weight: 500"
              >Trạng thái mới:</label
            >
            <select
              id="quick-status-select"
              required
              style="
                width: 100%;
                padding: 8px 10px;
                border-radius: 6px;
                border: 1px solid #ccc;
                margin-top: 6px;
              "
            >
              <option value="">Chọn trạng thái</option>
              <option value="Đã đặt">Đã đặt</option>
              <option value="Chưa nhận kit">Chưa nhận kit</option>
              <option value="Đã nhận kit">Đã nhận kit</option>
              <option value="Đã trả kit">Đã trả kit</option>
              <option value="Chưa lấy mẫu">Chưa lấy mẫu</option>
              <option value="Hoàn thành lấy mẫu">Hoàn thành lấy mẫu</option>
              <option value="Lỗi mẫu">Lỗi mẫu</option>
              <option value="Hoàn thành">Hoàn thành</option>
              <option value="Đã hủy">Đã hủy</option>
            </select>
          </div>
          <div style="display: flex; justify-content: flex-end; gap: 10px">
            <button
              type="button"
              id="quick-status-cancel"
              style="
                background: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 8px 18px;
                cursor: pointer;
              "
            >
              Hủy
            </button>
            <button
              type="submit"
              style="
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 8px 18px;
                cursor: pointer;
              "
            >
              Cập nhật
            </button>
          </div>
        </form>
      </div>
    </div>
    <script>
      function openQuickStatusModal(bookingId, currentStatus) {
        document.getElementById("quick-status-modal").style.display = "flex";
        document.getElementById("quick-status-booking-id").value = bookingId;
        const select = document.getElementById("quick-status-select");
        select.value = currentStatus || "";
      }
      document.getElementById("quick-status-close").onclick =
        document.getElementById("quick-status-cancel").onclick = function () {
          document.getElementById("quick-status-modal").style.display = "none";
        };
      document.getElementById("quick-status-form").onsubmit = async function (
        e
      ) {
        e.preventDefault();
        const bookingId = document.getElementById(
          "quick-status-booking-id"
        ).value;
        const newStatus = document.getElementById("quick-status-select").value;
        if (!newStatus) return;
        try {
          if (isDemoMode) {
            // Xử lý cập nhật trạng thái trong chế độ demo
            const index = appointmentsData.findIndex(
              (item) => item.id === bookingId
            );
            if (index !== -1) {
              appointmentsData[index].status = newStatus;

              // Cập nhật trạng thái trong demoAppointments để lưu giữ khi chuyển trang
              const demoIndex = demoAppointments.findIndex(
                (item) => item.id === bookingId
              );
              if (demoIndex !== -1) {
                demoAppointments[demoIndex].status = newStatus;
              }

              showSuccessToast(
                `[DEMO] Đã cập nhật trạng thái thành "${newStatus}" thành công!`
              );
              document.getElementById("quick-status-modal").style.display =
                "none";
              renderAppointments(appointmentsData);
            }
          } else {
            const response = await fetch(
              `/booking/staff/appointments/${bookingId}/status`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ status: newStatus }),
              }
            );
            if (!response.ok) throw new Error(await response.text());
            showSuccessToast("Cập nhật trạng thái thành công!");
            document.getElementById("quick-status-modal").style.display =
              "none";
            fetchAppointments(currentPage, pageSize, currentFilters);
          }
        } catch (err) {
          alert("Lỗi: " + err.message);
        }
      };
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (window.renderStaffSidebarInfo) window.renderStaffSidebarInfo();
      });
    </script>

    <script>
      // Function to view appointment details
      function viewAppointmentDetails(id) {
        // Truy vấn dữ liệu lịch hẹn từ danh sách
        const appointment = appointmentsData.find((a) => a.id === id);
        if (!appointment) {
          alert("Không tìm thấy thông tin lịch hẹn!");
          return;
        }

        // Tạo modal hiển thị thông tin chi tiết
        const modalContainer = document.createElement("div");
        modalContainer.id = "appointment-details-modal";
        modalContainer.style = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        `;

        // Format booking date
        const bookingDate = appointment.bookingDate
          ? new Date(appointment.bookingDate).toLocaleDateString("vi-VN")
          : "Không có";

        // Tạo nội dung modal
        modalContainer.innerHTML = `
          <div style="background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 650px; max-height: 85vh; overflow-y: auto; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
              <h2 style="margin: 0; color: #2196f3; font-size: 24px;">Chi tiết đánh giá</h2>
              <button onclick="document.getElementById('appointment-details-modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            
            <!-- Thông tin cơ bản về lịch hẹn và khách hàng -->
            <div style="background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
              <div style="display: flex; justify-content: space-between; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                  <p style="font-weight: bold; margin-bottom: 5px; color: #555;">Mã lịch hẹn:</p>
                  <p style="margin-top: 0; font-size: 16px;">${
                    appointment.id
                  }</p>
                </div>
                <div style="flex: 1; min-width: 200px;">
                  <p style="font-weight: bold; margin-bottom: 5px; color: #555;">Tên khách hàng:</p>
                  <p style="margin-top: 0; font-size: 16px;">${
                    appointment.customerName
                  }</p>
                </div>
              </div>
              <div style="margin-top: 10px;">
                <p style="font-weight: bold; margin-bottom: 5px; color: #555;">Trạng thái:</p>
                <div>${renderStatus(appointment.status)}</div>
              </div>
              <div style="margin-top: 10px;">
                <p style="font-weight: bold; margin-bottom: 5px; color: #555;">Ngày tạo đánh giá:</p>
                <p style="margin-top: 0;">${bookingDate}</p>
              </div>
            </div>
            
            <!-- Danh sách dịch vụ và đánh giá -->
            <h3 style="margin-top: 25px; margin-bottom: 15px; color: #444; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px;">Đánh giá dịch vụ</h3>
            
            ${renderServiceFeedbacks(appointment)}
            
            <div style="text-align: center; margin-top: 25px;">
              <button onclick="document.getElementById('appointment-details-modal').remove()" style="background-color: #2196f3; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s;">Đóng</button>
            </div>
          </div>
        `;

        document.body.appendChild(modalContainer);
      }

      // Function to render service feedbacks
      function renderServiceFeedbacks(appointment) {
        if (!appointment.services || appointment.services.length === 0) {
          return `<div style="text-align: center; padding: 20px; color: #666; background-color: #f8f9fa; border-radius: 5px;">
                    Không có thông tin dịch vụ
                  </div>`;
        }

        let servicesHtml = "";

        appointment.services.forEach((service, index) => {
          const serviceName =
            service.name ||
            serviceNames.find((s) => s.id === service.serviceId)?.name ||
            "Không có tên";

          servicesHtml += `
            <div style="background-color: ${
              index % 2 === 0 ? "#f8f9fa" : "#fff"
            }; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 3px solid #4caf50;">
              <div style="margin-bottom: 12px;">
                <p style="font-weight: bold; margin-bottom: 5px; color: #444;">Dịch vụ:</p>
                <p style="margin-top: 0; font-size: 16px;">${serviceName}</p>
              </div>
              
              <div style="margin-bottom: 12px;">
                <p style="font-weight: bold; margin-bottom: 5px; color: #444;">Đánh giá:</p>
                <div>${renderSatisfactionStars(
                  service.satisfactionRating
                )}</div>
              </div>
              
              ${
                service.comment
                  ? `
              <div>
                <p style="font-weight: bold; margin-bottom: 5px; color: #444;">Nhận xét:</p>
                <p style="margin-top: 0; padding: 10px; background-color: #fff; border-radius: 5px; border: 1px solid #e0e0e0;">
                  ${service.comment || "Không có nhận xét"}
                </p>
              </div>
              `
                  : ""
              }
            </div>
          `;
        });

        return servicesHtml;
      }
    </script>
  </body>
</html>
