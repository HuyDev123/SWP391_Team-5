<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Danh sách lịch hẹn - Dịch Vụ Xét Nghiệm ADN</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link rel="stylesheet" href="/assets/css/staff-auth.css" />
    <link rel="stylesheet" href="/assets/css/staff-style.css" />
    <link rel="stylesheet" href="/assets/css/staff-modal.css" />
    <style>
      body {
        display: flex;
        min-height: 100vh;
        background-color: #f5f5f5;
      }

      .text-container {
        display: flex;
        flex-direction: column;
      }

      #logout-btn.logout-btn i {
        margin-right: 8px;
        font-size: 18px;
      }
      .menu-title {
        padding: 20px 20px 10px 20px;
        color: #666;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        position: relative;
      }

      .menu-title::after {
        content: "";
        position: absolute;
        bottom: 5px;
        left: 20px;
        width: 30px;
        height: 2px;
        background: linear-gradient(90deg, #2196f3, #64b5f6);
        border-radius: 1px;
      }

      #mainMenu {
        padding: 10px 15px;
      }

      .menu-item {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        color: #555;
        text-decoration: none;
        border-radius: 12px;
        margin-bottom: 6px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        font-weight: 500;
      }

      .menu-item::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(33, 150, 243, 0.1),
          transparent
        );
        transition: left 0.6s ease;
      }

      .menu-item:hover::before {
        left: 100%;
      }

      .menu-item:hover {
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.1),
          rgba(33, 150, 243, 0.05)
        );
        color: #2196f3;
        transform: translateX(8px);
        box-shadow: 0 4px 20px rgba(33, 150, 243, 0.2);
      }

      .menu-item.active {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        transform: translateX(8px);
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4),
          0 0 0 1px rgba(255, 255, 255, 0.1);
      }

      .menu-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 14px;
        border-radius: 10px;
        background: linear-gradient(
          135deg,
          rgba(33, 150, 243, 0.15),
          rgba(33, 150, 243, 0.08)
        );
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
      }

      .menu-icon::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: radial-gradient(
          circle,
          rgba(255, 255, 255, 0.3),
          transparent 70%
        );
        border-radius: 50%;
        transform: translate(-50%, -50%);
        transition: all 0.3s ease;
      }

      .menu-item:hover .menu-icon {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.9),
          rgba(255, 255, 255, 0.7)
        );
        transform: scale(1.1) rotate(5deg);
        box-shadow: 0 6px 20px rgba(33, 150, 243, 0.3);
      }

      .menu-item:hover .menu-icon::after {
        width: 30px;
        height: 30px;
      }

      .menu-item.active .menu-icon {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.3),
          rgba(255, 255, 255, 0.1)
        );
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      .menu-icon i {
        font-size: 18px;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 1;
        position: relative;
      }

      .menu-item:hover .menu-icon i {
        transform: scale(1.2);
        color: #2196f3;
      }

      .menu-item.active .menu-icon i {
        color: white;
        transform: scale(1.1);
      }

      @media (max-width: 600px) {
        #logout-btn.logout-btn {
          width: 100%;
          font-size: 15px;
          padding: 10px 0;
        }
        .user-info {
          flex-direction: column;
          gap: 10px;
        }
        .user-details {
          text-align: center;
        }
      }

      /* Login buttons */
      .login-buttons {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 10px;
      }

      .google-login-btn,
      .demo-login-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        border: none;
      }

      .google-login-btn {
        background-color: white;
        color: #757575;
        border: 1px solid #dadce0;
      }

      .google-login-btn:hover {
        background-color: #f5f5f5;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .google-login-btn i {
        margin-right: 10px;
        color: #4285f4;
        font-size: 18px;
      }

      .demo-login-btn {
        background-color: #1976d2;
        color: white;
      }

      .demo-login-btn:hover {
        background-color: #1565c0;
      }

      .demo-login-btn i {
        margin-right: 10px;
      }

      /* Demo accounts dropdown */
      .demo-accounts-dropdown {
        position: absolute;
        top: 100%;
        left: 20px;
        right: 20px;
        background: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        z-index: 100;
        overflow: hidden;
      }

      .demo-account-item {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .demo-account-item:hover {
        background-color: #f5f5f5;
      }

      .demo-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        color: white;
        font-weight: 500;
      }

      .demo-info {
        display: flex;
        flex-direction: column;
      }

      .demo-name {
        font-size: 14px;
        font-weight: 500;
      }

      .demo-role {
        font-size: 12px;
        color: #666;
      } /* Main content styles */
      .main-content {
        margin-left: 280px;
        padding: 25px;
        width: calc(100% - 280px);
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      }

      .navbar {
        display: flex;
        margin: 20px 0;
        background-color: white;
        border-radius: 5px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .nav-item {
        padding: 15px 20px;
        text-decoration: none;
        color: #333;
        display: flex;
        align-items: center;
        border-bottom: 2px solid transparent;
      }

      .nav-item.active {
        border-bottom: 2px solid #2196f3;
        color: #2196f3;
      }

      .nav-icon {
        margin-right: 10px;
      }

      /* Sample collection styles */
      .sample-header {
        background-image: linear-gradient(
            rgba(0, 0, 0, 0.6),
            rgba(0, 0, 0, 0.6)
          ),
          url("/assets/images/banner.jpg");
        background-size: cover;
        background-position: center;
        color: white;
        padding: 60px 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        text-align: center;
      }

      .sample-header h1 {
        font-size: 32px;
        margin-bottom: 15px;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
      }

      .sample-header p {
        font-size: 18px;
        max-width: 800px;
        margin: 0 auto;
        line-height: 1.6;
      }

      .instruction-container {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }

      .instruction-title {
        font-size: 24px;
        color: #2196f3;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .warning-box {
        background-color: #fff8e1;
        border-left: 4px solid #ff9800;
        padding: 15px;
        margin: 20px 0;
        border-radius: 0 5px 5px 0;
      }

      .warning-title {
        display: flex;
        align-items: center;
        font-weight: bold;
        margin-bottom: 10px;
        color: #e65100;
      }

      .warning-icon {
        margin-right: 10px;
        font-size: 20px;
      }

      .steps-container {
        margin-top: 30px;
      }

      .step {
        display: flex;
        margin-bottom: 30px;
        position: relative;
      }

      .step-number {
        width: 50px;
        height: 50px;
        background-color: #2196f3;
        color: white;
        font-size: 24px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 20px;
        flex-shrink: 0;
      }

      .step-content {
        flex: 1;
      }

      .step-title {
        font-size: 20px;
        margin-bottom: 10px;
        color: #333;
      }

      .step-description {
        color: #555;
        line-height: 1.6;
      }

      .step-image {
        width: 100%;
        max-width: 300px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .step-timeline {
        position: absolute;
        left: 24px;
        top: 50px;
        bottom: -30px;
        width: 2px;
        background-color: #2196f3;
      }

      .step:last-child .step-timeline {
        display: none;
      }

      .step-tip {
        background-color: #e3f2fd;
        padding: 15px;
        border-radius: 8px;
        margin-top: 15px;
      }

      .step-tip-title {
        font-weight: bold;
        display: flex;
        align-items: center;
        margin-bottom: 5px;
        color: #0d47a1;
      }

      .step-tip-icon {
        margin-right: 8px;
      }

      .step-bullet-list {
        margin-top: 15px;
        margin-left: 5px;
        list-style-type: none;
      }

      .step-bullet-list li {
        position: relative;
        padding-left: 28px;
        margin-bottom: 12px;
        line-height: 1.6;
      }

      .step-bullet-list li:before {
        content: "•";
        position: absolute;
        left: 0;
        top: 0;
        color: #2196f3;
        font-size: 24px;
        line-height: 1;
      }

      .step-image-container {
        margin-top: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      .step-image-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
      }

      .step-image {
        width: 100%;
        max-width: 400px;
        display: block;
        border-radius: 8px;
      }

      .step-content {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
      }

      .step-text {
        flex: 1;
        min-width: 300px;
      }

      .step-visual {
        flex: 1;
        min-width: 300px;
        padding-left: 20px;
        display: flex;
        justify-content: center;
      }
      .sample-types {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .sample-type {
        flex: 1;
        min-width: 250px;
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border-left: 4px solid #2196f3;
      }
      .sample-type:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 768px) {
        .step-content {
          flex-direction: column;
        }

        .step-visual {
          padding-left: 0;
          margin-top: 20px;
          width: 100%;
        }
      }
      .sample-type-title {
        font-size: 18px;
        margin-bottom: 10px;
        color: #333;
        display: flex;
        align-items: center;
      }

      .sample-type-icon {
        margin-right: 10px;
        color: #2196f3;
        font-size: 20px;
      }

      .sample-type-content {
        color: #555;
        line-height: 1.5;
      }

      /* Video section */
      .video-section {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }

      .video-title {
        font-size: 24px;
        color: #2196f3;
        margin-bottom: 20px;
      }

      .video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
        overflow: hidden;
        border-radius: 8px;
      }

      .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
      }

      /* FAQs section */
      .faq-section {
        background-color: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .faq-title {
        font-size: 24px;
        color: #2196f3;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .faq-item {
        margin-bottom: 20px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
      }

      .faq-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .faq-question {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
        display: flex;
        align-items: flex-start;
      }

      .question-icon {
        color: #2196f3;
        margin-right: 10px;
        flex-shrink: 0;
      }

      .faq-answer {
        color: #555;
        line-height: 1.6;
        padding-left: 30px;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          height: auto;
          position: relative;
        }

        .main-content {
          margin-left: 0;
          width: 100%;
        }

        .step {
          flex-direction: column;
        }

        .step-number {
          margin-bottom: 15px;
          margin-right: 0;
        }

        .step-timeline {
          display: none;
        }
      }
      .highlighted-step {
        animation: highlight-step 3s ease;
      }

      @keyframes highlight-step {
        0%,
        100% {
          background-color: transparent;
        }
        20%,
        80% {
          background-color: rgba(33, 150, 243, 0.1);
          box-shadow: 0 0 15px rgba(33, 150, 243, 0.3);
          transform: translateY(-5px);
        }
      }

      /* Đảm bảo các bước có đủ padding cho hiệu ứng */
      .step {
        padding: 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
        margin-bottom: 30px;
      }
      .menu-icon i {
        font-size: 18px;
        width: 20px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .menu-item.active .menu-icon i {
        color: white;
      }

      .menu-item:hover .menu-icon i {
        transform: scale(1.1);
        color: #2196f3;
      }

      /* Scrollbar styling */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #2196f3;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #1976d2;
      }

      /* CSS chung cho các modal để đảm bảo hiển thị tốt trên mọi thiết bị */
      .modal-container {
        display: flex;
        justify-content: center;
        align-items: flex-start; /* Căn lề trên để dễ cuộn */
        padding: 20px 0;
      }

      /* Style chung cho iframe trong modal */
      .modal-iframe {
        background-color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        width: 100%;
        height: 85vh;
        max-height: calc(100vh - 60px);
        overflow: auto;
      }

      /* Kiểu hiển thị nút close */
      .modal-close-btn {
        position: fixed;
        top: 15px;
        right: 15px;
        z-index: 10002;
        background: white;
        color: #f44336;
        border: none;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        transition: all 0.2s;
      }

      .modal-close-btn:hover {
        transform: scale(1.1);
        background: #ffebee;
      }

      /* Styling cho backdrop */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(3px);
        z-index: 10000;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: 1px solid transparent;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      /* Trạng thái đã đặt - Xanh dương */
      .status-booked {
        background-color: #e3f2fd;
        color: #1565c0;
        border-color: #2196f3;
      }

      /* Trạng thái chưa thanh toán - Tím */
      .status-payment-pending {
        background-color: #f3e5f5;
        color: #7b1fa2;
        border-color: #9c27b0;
      }

      /* Flow Tại nhà - Kit pending - Cam */
      .status-kit-pending {
        background-color: #fff3e0;
        color: #e65100;
        border-color: #ff9800;
      }

      /* Flow Tại nhà - Kit received - Tím */
      .status-kit-received {
        background-color: #f3e5f5;
        color: #7b1fa2;
        border-color: #9c27b0;
      }

      /* Flow Tại nhà - Kit returned - Tím đậm */
      .status-kit-returned {
        background-color: #e8eaf6;
        color: #3f51b5;
        border-color: #673ab7;
      }

      /* Flow Tại cơ sở - Chưa lấy mẫu - Xanh lá */
      .status-not-sampled {
        background-color: #e8f5e8;
        color: #2e7d32;
        border-color: #4caf50;
      }

      /* Chung cho cả 2 flow - Hoàn thành lấy mẫu - Xanh lá đậm */
      .status-sampling-completed {
        background-color: #e0f2e0;
        color: #1b5e20;
        border-color: #388e3c;
      }

      /* Lỗi mẫu - Đỏ */
      .status-sample-error {
        background-color: #ffebee;
        color: #c62828;
        border-color: #f44336;
      }

      /* Hoàn thành cuối cùng - Xanh ngọc */
      .status-final-completed {
        background-color: #e0f2f1;
        color: #00695c;
        border-color: #009688;
      }

      /* Đã hủy - Xám */
      .status-cancelled {
        background-color: #f5f5f5;
        color: #424242;
        border-color: #9e9e9e;
      }

      /* Trạng thái cũ (backwards compatibility) */
      .status-waiting {
        background-color: #fff3e0;
        color: #e65100;
        border-color: #ff9800;
      }

      .status-received {
        background-color: #e3f2fd;
        color: #1565c0;
        border-color: #2196f3;
      }

      .status-completed {
        background-color: #e0f2e0;
        color: #1b5e20;
        border-color: #388e3c;
      }

      .status-delivered {
        background-color: #e0f2f1;
        color: #00695c;
        border-color: #009688;
      }

      /* Modal styles cho chi tiết lịch hẹn */
      .appointment-details-modal {
        animation: fadeIn 0.3s ease;
      }

      .modal-content {
        animation: scaleIn 0.3s ease;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #edf2f7;
        margin-bottom: 20px;
        padding-bottom: 15px;
      }

      .modal-title {
        font-size: 24px;
        color: #2196f3;
        font-weight: 600;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .modal-close:hover {
        color: #f44336;
        transform: scale(1.1);
      }

      .service-list {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
      }

      .service-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 16px 0;
        border-bottom: 1px solid #edf2f7;
        transition: all 0.3s ease;
      }

      .service-item:last-child {
        border-bottom: none;
      }

      .service-item:hover {
        transform: translateX(5px);
        background-color: rgba(33, 150, 243, 0.02);
        border-radius: 8px;
        padding-left: 8px;
        padding-right: 8px;
      }

      .total-amount {
        margin-top: 20px;
        padding: 20px;
        border-top: 2px solid #edf2f7;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        font-size: 16px;
        font-weight: 500;
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Modal styles cho chỉnh sửa lịch hẹn */
      .appointment-edit-modal {
        animation: fadeIn 0.3s ease;
      }

      .appointment-edit-modal .modal-content {
        animation: scaleIn 0.3s ease;
      }

      .appointment-edit-modal input,
      .appointment-edit-modal select,
      .appointment-edit-modal textarea {
        transition: all 0.3s ease;
      }

      .appointment-edit-modal input:focus,
      .appointment-edit-modal select:focus,
      .appointment-edit-modal textarea:focus {
        border-color: #2196f3;
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        outline: none;
      }

      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        cursor: pointer;
      }

      .btn-primary {
        background: linear-gradient(45deg, #2196f3, #1976d2);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #4caf50, #388e3c);
        color: white;
      }

      /* Badge trạng thái giống kit-management-customer.html */
      .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .status-pending {
        background-color: rgba(158, 158, 158, 0.1);
        color: #9e9e9e;
      }
      .status-confirmed {
        background-color: rgba(33, 150, 243, 0.1);
        color: #2196f3;
      }
      .status-sampled {
        background-color: rgba(103, 58, 183, 0.1);
        color: #673ab7;
      }
      .status-paid {
        background-color: rgba(76, 175, 80, 0.1);
        color: #4caf50;
      }
      .status-done {
        background-color: rgba(255, 152, 0, 0.1);
        color: #ff9800;
      }
      .status-cancel {
        background-color: rgba(244, 67, 54, 0.1);
        color: #f44336;
      }
    </style>
    <!-- Thêm vào phần <head> của mỗi trang -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />

    <style>
      /* Hiệu ứng chuyển động mượt mà */
      .hero-banner,
      .content-section,
      .service-card,
      .step-item,
      .contact-btn {
        transition: all 0.5s ease;
      }

      /* Cải thiện hero banner */
      .hero-banner {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .hero-banner:hover {
        transform: translateY(-5px);
      }

      /* Hiệu ứng cho các section */
      .content-section {
        transition: transform 0.4s ease, box-shadow 0.4s ease;
      }

      .content-section:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      }

      /* Hiệu ứng facility items */
      .facility-item {
        transition: all 0.4s ease;
      }

      .facility-item:hover {
        transform: translateY(-8px);
      }

      .facility-item .icon-wrapper {
        transition: all 0.5s ease;
      }

      .facility-item:hover .icon-wrapper {
        transform: rotateY(180deg);
      }

      /* Card hover effects */
      .service-card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 30px rgba(33, 150, 243, 0.1);
      }

      .service-card .card-icon {
        transition: all 0.5s ease;
      }

      .service-card:hover .card-icon {
        transform: rotateY(360deg);
        background-color: #2196f3;
        color: white;
      }

      /* Step item animations */
      .step-item {
        position: relative;
        overflow: hidden;
      }

      .step-item:hover {
        background-color: #f9f9f9;
        padding-left: 15px;
        border-radius: 8px;
      }

      .step-item .step-number,
      .step-item .step-icon {
        transition: all 0.4s ease;
      }

      .step-item:hover .step-number {
        transform: scale(1.2);
      }

      .step-item:hover .step-icon {
        transform: rotate(360deg);
      }

      /* Contact button effects */
      .contact-btn {
        transform-origin: center;
        transition: all 0.3s ease;
      }

      .contact-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      }

      .contact-btn i {
        transition: all 0.4s ease;
      }

      .contact-btn:hover i {
        transform: scale(1.2);
      }

      /* Sidebar menu hover effect */
      .menu-item {
        transition: all 0.3s ease;
      }

      .menu-item:hover .menu-icon {
        transform: scale(1.2);
        transition: transform 0.3s ease;
      }

      /* Gradient buttons */
      .login-register-btn {
        background-image: linear-gradient(45deg, #2196f3, #1976d2);
        transition: all 0.3s ease;
      }

      .login-register-btn:hover {
        background-image: linear-gradient(45deg, #1976d2, #0d47a1);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
      }

      /* Animation for facility section */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* Specific styles for the filter form that won't be affected by global styles */
      .genx-filter-form {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 16px !important;
        align-items: center !important;
        margin-bottom: 20px !important;
        flex-direction: row !important; /* Override the column direction from global styles */
      }

      .genx-filter-form div {
        margin: 0 !important;
      }

      .genx-filter-form input,
      .genx-filter-form select {
        padding: 6px 10px !important;
        border: 1px solid #ccc !important;
        border-radius: 4px !important;
      }

      .genx-filter-form button[type="submit"] {
        background: #2196f3 !important;
        color: white !important;
        border: none !important;
        border-radius: 4px !important;
        padding: 8px 18px !important;
        cursor: pointer !important;
      }

      .genx-filter-form button[type="reset"] {
        background: #f5f5f5 !important;
        color: #333 !important;
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
        padding: 8px 18px !important;
        cursor: pointer !important;
        margin-left: 8px !important;
      }
    </style>
  </head>
  <body>
    <script th:inline="javascript">
      /*<![CDATA[*/
      window.serverStaff = /*[[${staffData}]]*/ null;
      /*]]>*/
    </script>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo-container">
        <img src="/assets/images/logo.png" alt="Logo" class="logo" />
        <div class="text-container">
          <div class="logo-text">Genx</div>
          <div class="logo-subtext">Trung tâm xét nghiệm ADN huyết thống</div>
        </div>
      </div>
      <div class="login-register" id="login-register">
        <div id="user-info-container"></div>
      </div>
      <div class="menu-title">MAIN MENU</div>
      <div id="mainMenu">
        <a href="/staff-home" class="menu-item">
          <span class="menu-icon"><i class="fas fa-home"></i></span>
          Trang chủ
        </a>

        <a href="/staff-appointments" class="menu-item active">
          <span class="menu-icon"><i class="fas fa-clipboard-list"></i></span>
          Danh sách lịch hẹn
        </a>

        <a href="/staff-kit-list" class="menu-item">
          <span class="menu-icon"><i class="fas fa-vials"></i></span>
          Quản lý kit xét nghiệm
        </a>

        <a href="/payment-management" class="menu-item">
          <span class="menu-icon"><i class="fas fa-money-bill-wave"></i></span>
          Quản lý thanh toán
        </a>

        <a href="/staff-participants" class="menu-item">
          <span class="menu-icon"><i class="fas fa-users"></i></span>
          Quản lý người tham gia
        </a>

        <a href="/staff-samples" class="menu-item">
          <span class="menu-icon"><i class="fas fa-flask"></i></span>
          Quản lý mẫu xét nghiệm
        </a>

        <a href="/staff-results" class="menu-item">
          <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
          Quản lý kết quả xét nghiệm
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Navigation Bar -->
      <div id="topNavbar" class="navbar">
        <!-- Navbar sẽ được thêm bằng JavaScript -->
      </div>
      <!-- Phần cần code -->
      <!-- ...existing code... -->
      <div class="instruction-container" style="margin-top: 10px">
        <div class="instruction-title">
          <i class="fas fa-calendar-alt" style="color: #2196f3"></i>
          Danh sách lịch hẹn xét nghiệm ADN
        </div>
        <!-- Bộ lọc -->
        <form
          id="filterForm"
          class="genx-filter-form"
          style="
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <div>
            <label for="searchFilter" style="font-weight: 500; color: #333"
              >Tìm kiếm:</label
            >
            <input
              type="text"
              id="searchFilter"
              name="searchFilter"
              placeholder="Mã lịch hẹn, mã KH hoặc tên"
              style="
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
                width: 240px;
              "
            />
          </div>
          <div>
            <label for="serviceFilter" style="font-weight: 500; color: #333"
              >Dịch vụ:</label
            >
            <select
              id="serviceFilter"
              name="serviceFilter"
              style="
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            >
              <option value="">Tất cả</option>
              <option value="1">Xét nghiệm ADN Cha - Con</option>
              <option value="2">Xét nghiệm ADN Mẹ - Con</option>
              <option value="3">Xét nghiệm ADN Anh/Chị - Em</option>
              <option value="4">Xét nghiệm ADN Ông/Bà - Cháu</option>
            </select>
          </div>
          <div>
            <label for="dateFilter" style="font-weight: 500; color: #333"
              >Ngày hẹn:</label
            >
            <input
              type="date"
              id="dateFilter"
              name="dateFilter"
              style="
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
          </div>
          <div>
            <label for="statusFilter" style="font-weight: 500; color: #333"
              >Trạng thái:</label
            >
            <select
              id="statusFilter"
              name="statusFilter"
              style="
                padding: 6px 10px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            >
              <option value="">Tất cả</option>
              <option value="Đã đặt">Đã đặt</option>
              <option value="Chưa thanh toán">Chưa thanh toán</option>
              <option value="Chưa nhận kit">Chưa nhận kit</option>
              <option value="Đã nhận kit">Đã nhận kit</option>
              <option value="Đã trả kit">Đã trả kit</option>
              <option value="Chưa lấy mẫu">Chưa lấy mẫu</option>
              <option value="Hoàn thành lấy mẫu">Hoàn thành lấy mẫu</option>
              <option value="Lỗi mẫu">Lỗi mẫu</option>
              <option value="Hoàn thành">Hoàn thành</option>
              <option value="Đã hủy">Đã hủy</option>
            </select>
          </div>
          <div>
            <button
              type="submit"
              style="
                background: #2196f3;
                color: white;
                border: none;
                border-radius: 4px;
                padding: 8px 18px;
                cursor: pointer;
              "
            >
              <i class="fas fa-search"></i> Tìm kiếm
            </button>
            <button
              type="reset"
              style="
                background: #f5f5f5;
                color: #333;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 8px 18px;
                cursor: pointer;
                margin-left: 8px;
              "
              onclick="resetFilter()"
            >
              <i class="fas fa-redo"></i> Đặt lại
            </button>
          </div>
        </form>

        <div style="overflow-x: auto">
          <table
            style="width: 100%; border-collapse: collapse; margin-top: 10px"
          >
            <thead>
              <tr style="background: #e3f2fd">
                <th style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left;">
                  Mã
                </th>
                <th style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left;">
                  Tên khách hàng
                </th>
                <th style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left;">
                  Phương thức lấy mẫu
                </th>
                <th style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left;">
                  Ngày đặt lịch
                </th>
                <th style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left;">
                  Trạng thái
                </th>
                <th style="padding: 12px 8px; border-bottom: 1px solid #eee; text-align: left;">
                  Thao tác
                </th>
              </tr>
            </thead>
            <tbody id="appointmentTableBody">
              <!-- Dữ liệu sẽ được render bằng JS -->
            </tbody>
          </table>
        </div>
      </div>
      <script>
        // Danh sách dịch vụ mẫu (có loại)
        const serviceNames = [
          { id: 1, name: "Xét nghiệm ADN Cha - Con" },
          { id: 2, name: "Xét nghiệm ADN Mẹ - Con" },
          { id: 3, name: "Xét nghiệm ADN Anh/Chị - Em" },
          { id: 4, name: "Xét nghiệm ADN Ông/Bà - Cháu" },
        ];

        // Lưu trữ dữ liệu lịch hẹn từ API
        let appointmentsData = [];
        let currentPage = 0;
        let totalPages = 1;
        let pageSize = 10;
        // Lưu filter hiện tại
        let currentFilters = {
          serviceId: "",
          date: "",
          status: "",
          searchQuery: "",
        };

        // Hàm để lấy dữ liệu lịch hẹn từ server (có filter)
        async function fetchAppointments(page = 0, size = 10, filters = {}) {
          try {
            // Build query string
            let params = new URLSearchParams();
            params.append("page", page);
            params.append("size", size);
            if (filters.status) params.append("status", filters.status);
            if (filters.date) params.append("date", filters.date);
            if (filters.serviceId)
              params.append("serviceId", filters.serviceId);
            if (filters.searchQuery)
              params.append("searchQuery", filters.searchQuery);

            const response = await fetch(
              `/booking/staff/appointments?${params.toString()}`,
              {
                method: "GET",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include", // Để gửi cookie
              }
            );

            if (response.status === 401) {
              window.location.href = "/internal-login";
              return;
            }

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            appointmentsData = data.content;
            currentPage = data.page;
            totalPages = data.totalPages;
            pageSize = data.size;
            renderAppointments(appointmentsData);
            renderPagination();
            return data;
          } catch (error) {
            console.error("Lỗi khi lấy dữ liệu lịch hẹn:", error);
            renderAppointments([]);
            renderPagination();
          }
        }

        // Sửa renderPagination để truyền filter khi chuyển trang
        function renderPagination() {
          const containerId = "pagination-container";
          let container = document.getElementById(containerId);
          if (!container) {
            container = document.createElement("div");
            container.id = containerId;
            container.style =
              "display:flex;justify-content:center;align-items:center;margin:20px 0;gap:8px;";
            document.querySelector(".main-content").appendChild(container);
          }
          container.innerHTML = "";
          if (totalPages <= 1) return;
          // Nút prev
          const prevBtn = document.createElement("button");
          prevBtn.innerText = "«";
          prevBtn.className = "btn btn-primary";
          prevBtn.disabled = currentPage === 0;
          prevBtn.onclick = () =>
            fetchAppointments(currentPage - 1, pageSize, currentFilters);
          container.appendChild(prevBtn);
          // Số trang
          for (let i = 0; i < totalPages; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.innerText = i + 1;
            pageBtn.className =
              "btn" + (i === currentPage ? " btn-success" : " btn-primary");
            pageBtn.disabled = i === currentPage;
            pageBtn.onclick = () =>
              fetchAppointments(i, pageSize, currentFilters);
            container.appendChild(pageBtn);
          }
          // Nút next
          const nextBtn = document.createElement("button");
          nextBtn.innerText = "»";
          nextBtn.className = "btn btn-primary";
          nextBtn.disabled = currentPage === totalPages - 1;
          nextBtn.onclick = () =>
            fetchAppointments(currentPage + 1, pageSize, currentFilters);
          container.appendChild(nextBtn);
        }

        // Cập nhật hàm renderStatus để sử dụng badge styles
        function renderStatusBadge(status) {
          let color = '#333';
          let fontWeight = 'bold';
          switch (status) {
            case 'Đã đặt':
              color = '#1976d2';
              break;
            case 'Chưa lấy mẫu':
              color = '#2196f3';
              break;
            case 'Đã lấy mẫu':
              color = '#ff9800'; // Orange
              break;
            case 'Đã trả kết quả':
              color = '#4caf50'; // Green
              break;
            case 'Đã hủy':
              color = '#f44336';
              break;
            default:
              color = '#757575';
          }
          return `<span style="color: ${color}; font-weight: ${fontWeight};">${status}</span>`;
        }

        // Cập nhật hàm render bảng
        function renderAppointments(data) {
          const tbody = document.getElementById("appointmentTableBody");
          tbody.innerHTML = data.length
            ? data
                .map(
                  (a) => `
            <tr>
              <td>${a.id}</td>
              <td>${a.customerName}</td>
              <td>${a.method}</td>
              <td>${a.bookingDate.substring(0, 10)}</td>
              <td>${renderStatusBadge(a.status)}</td>
              <td style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="viewAppointmentDetails(${
                  a.id
                })" class="btn btn-primary" style="background:#e3f2fd;color:#1976d2;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
                  <i class="fas fa-info-circle"></i> Xem
                </button>
                ${renderActionButtons(a)}
              </td>
            </tr>
          `
                )
                .join("")
            : `<tr><td colspan="6" style="text-align:center; color:#888; padding:20px;">Không có lịch hẹn phù hợp</td></tr>`;
        }

        // Hàm render các nút action dựa trên trạng thái
        function renderActionButtons(appointment) {
          let buttons = "";

          // Nút "Checkin" chỉ cho trạng thái "Đã đặt" VÀ ngày hiện tại >= ngày hẹn (nếu có ngày hẹn)
          if (
            appointment.status === "Đã đặt" &&
            appointment.appointmentDateTime &&
            (() => {
              // So sánh ngày hiện tại >= ngày hẹn (chỉ tính ngày)
              const apptDateStr = appointment.appointmentDateTime.split(" ")[0];
              const [y, m, d] = apptDateStr.split('-');
              const apptDate = new Date(Number(y), Number(m) - 1, Number(d)); // local 0h
              const today = new Date();
              today.setHours(0,0,0,0);
              return today.getTime() >= apptDate.getTime();
            })()
          ) {
            buttons += `
              <button onclick="openCheckinModal(${appointment.id})" class="btn" style="background:#ff9800;color:white;border:none;border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-check"></i> Checkin
              </button>
            `;
          }

          // Nút "Thanh toán" cho lấy mẫu tại cơ sở, trạng thái "Chưa thanh toán"
          if (
            appointment.method === "Tại trung tâm" &&
            appointment.status === "Chưa thanh toán"
          ) {
            buttons += `
              <button onclick="handlePayment(${appointment.id})" class="btn btn-primary" style="border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-credit-card"></i> Thanh toán
              </button>
            `;
          }

          // Nút "Lấy mẫu" cho lấy mẫu tại trung tâm, trạng thái "Chưa lấy mẫu"
          if (
            appointment.method === "Tại trung tâm" &&
            appointment.status === "Chưa lấy mẫu"
          ) {
            buttons += `
              <button onclick="checkAndHandleSampleInput(${appointment.id}, 'booking')" class="btn btn-success" style="border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-vial"></i> Lấy mẫu
              </button>
            `;
          }

          // Nút "Quản lý kit" cho lấy mẫu tại nhà, trạng thái "Chưa lấy mẫu"
          if (
            appointment.method === "Tại nhà" &&
            appointment.status === "Chưa lấy mẫu"
          ) {
            buttons += `
              <a href="/staff-kit-list" class="btn btn-primary" style="border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-box"></i> Quản lý kit
              </a>
            `;
          }

          // Nút "Thêm KQ" cho trạng thái "Đã lấy mẫu"
          if (appointment.status === "Đã lấy mẫu") {
            buttons += `
              <button onclick="handleAddResult(${appointment.id})" class="btn btn-primary" style="border-radius:4px;padding:6px 12px;cursor:pointer;">
                <i class="fas fa-plus"></i> Thêm KQ
              </button>
            `;
          }

          return buttons;
        }

        // Hàm xác nhận thay đổi trạng thái nhanh
        async function confirmStatusChange(bookingId, newStatus) {
          showConfirmModal(
            `Xác nhận thay đổi trạng thái`,
            `Bạn có chắc chắn muốn chuyển trạng thái sang <strong>"${newStatus}"</strong>?`,
            async () => {
          try {
            const response = await fetch(
              `/booking/staff/appointments/${bookingId}/status`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ status: newStatus }),
              }
            );

            if (response.status === 401) {
              window.location.href = "/internal-login";
              return;
            }

            if (response.status === 402) {
              // Lỗi thanh toán chưa đủ
              const errorMessage = await response.text();
              showPaymentWarningModal(errorMessage, bookingId);
              return;
            }

            if (!response.ok) {
              throw new Error(await response.text());
            }

            showSuccessToast(
              `Đã cập nhật trạng thái thành "${newStatus}" thành công!`
            );
            fetchAppointments(currentPage, pageSize, currentFilters);
          } catch (error) {
            console.error("Lỗi khi cập nhật trạng thái:", error);
                showErrorModal("Có lỗi xảy ra khi cập nhật trạng thái: " + error.message);
              }
            }
          );
        }

        // Hàm hiển thị modal xác nhận tùy chỉnh
        function showConfirmModal(title, message, onConfirm) {
          // Xóa modal cũ nếu có
          const existingModal = document.getElementById('confirmModal');
          if (existingModal) {
            existingModal.remove();
          }

          const modal = document.createElement('div');
          modal.id = 'confirmModal';
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: fadeIn 0.3s ease;
          `;

          modal.innerHTML = `
            <div style="
              background: white;
              border-radius: 12px;
              padding: 0;
              width: 90%;
              max-width: 500px;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
              animation: slideIn 0.3s ease;
              position: relative;
              overflow: hidden;
            ">
              <div class="modal-header" style="
                background: #667eea;
                color: white;
                padding: 20px 30px;
                border-radius: 12px 12px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0;
              ">
                <h3 style="
                  margin: 0;
                  color: white;
                  font-size: 20px;
                  font-weight: 600;
                ">${title}</h3>
                <button onclick="this.closest('#confirmModal').remove()" style="
                  background: none;
                  border: none;
                  font-size: 24px;
                  color: white;
                  cursor: pointer;
                  width: 30px;
                  height: 30px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 50%;
                  transition: all 0.2s;
                " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">&times;</button>
              </div>
              <div class="modal-body">
                <div style="
                  margin-bottom: 25px;
                  color: #555;
                  font-size: 16px;
                  line-height: 1.6;
                ">${message}</div>

              <div style="
                display: flex;
                justify-content: flex-end;
                gap: 12px;
              ">
                <button onclick="this.closest('#confirmModal').remove()" style="
                  background: #f5f5f5;
                  color: #666;
                  border: 1px solid #ddd;
                  border-radius: 8px;
                  padding: 12px 24px;
                  cursor: pointer;
                  font-weight: 500;
                  font-size: 14px;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                " onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">
                  <i class="fas fa-times"></i>
                  Hủy bỏ
                </button>
                <button onclick="handleConfirmAction()" style="
                  background: linear-gradient(135deg, #2196f3, #1976d2);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  padding: 12px 24px;
                  cursor: pointer;
                  font-weight: 500;
                  font-size: 14px;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
                " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(33, 150, 243, 0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(33, 150, 243, 0.3)'">
                  <i class="fas fa-check"></i>
                  Xác nhận
                </button>
              </div>
            </div>
          </div>
          `;

          document.body.appendChild(modal);

          // Lưu callback để sử dụng trong handleConfirmAction
          window.confirmCallback = onConfirm;

          // Đóng modal khi click ra ngoài
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.remove();
            }
          });

          // Thêm CSS animations
          const style = document.createElement('style');
          style.textContent = `
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
            @keyframes slideIn {
              from { 
                transform: translateY(-50px) scale(0.95);
                opacity: 0;
              }
              to { 
                transform: translateY(0) scale(1);
                opacity: 1;
              }
            }
          `;
          document.head.appendChild(style);
        }

        // Hàm xử lý khi bấm nút xác nhận
        function handleConfirmAction() {
          const modal = document.getElementById('confirmModal');
          if (modal) {
            modal.remove();
          }
          
          if (window.confirmCallback) {
            window.confirmCallback();
            window.confirmCallback = null;
          }
        }

        // Hàm hiển thị modal lỗi tùy chỉnh
        function showErrorModal(message) {
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            animation: fadeIn 0.3s ease;
          `;

          modal.innerHTML = `
            <div style="
              background: white;
              border-radius: 12px;
              padding: 0;
              width: 90%;
              max-width: 500px;
              box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
              animation: slideIn 0.3s ease;
              position: relative;
              overflow: hidden;
            ">
              <div class="modal-header" style="
                background: #667eea;
                color: white;
                padding: 20px 30px;
                border-radius: 12px 12px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 0;
              ">
                <h3 style="
                  margin: 0;
                  color: white;
                  font-size: 20px;
                  font-weight: 600;
                ">Lỗi</h3>
                <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="
                  background: none;
                  border: none;
                  font-size: 24px;
                  color: white;
                  cursor: pointer;
                  width: 30px;
                  height: 30px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  border-radius: 50%;
                  transition: all 0.2s;
                " onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">&times;</button>
              </div>
              <div class="modal-body">
                <div style="
                  margin-bottom: 25px;
                  color: #555;
                  font-size: 16px;
                  line-height: 1.6;
                ">${message}</div>

              <div style="
                display: flex;
                justify-content: flex-end;
              ">
                <button onclick="this.closest('div[style*=\'position: fixed\']').remove()" style="
                  background: linear-gradient(135deg, #f44336, #d32f2f);
                  color: white;
                  border: none;
                  border-radius: 8px;
                  padding: 12px 24px;
                  cursor: pointer;
                  font-weight: 500;
                  font-size: 14px;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
                " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 20px rgba(244, 67, 54, 0.4)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 4px 15px rgba(244, 67, 54, 0.3)'">
                  <i class="fas fa-times"></i>
                  Đóng
                </button>
              </div>
            </div>
          </div>
          `;

          document.body.appendChild(modal);

          // Đóng modal khi click ra ngoài
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        // Hàm hiển thị modal cảnh báo thanh toán custom, đồng bộ UI với modal xem chi tiết
        function showPaymentWarningModal(message, bookingId) {
          // Xóa modal cũ nếu có
          const existingModal = document.getElementById('paymentWarningModal');
          if (existingModal) {
            existingModal.remove();
          }

          // Tạo modal custom
          const modal = document.createElement('div');
          modal.id = 'paymentWarningModal';
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10002;
          `;
          modal.innerHTML = `
            <div style="background: white; border-radius: 12px; padding: 0; width: 600px; max-width: 90vw; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); position: relative;">
              <div class="modal-header" style="background: #667eea; color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; margin: 0;">
                <h3 style="margin: 0; color: white; font-size: 22px; display: flex; align-items: center; gap: 8px;">
                  <i class='fas fa-exclamation-triangle' style='color: white;'></i>
                  Cảnh báo: Chưa thanh toán đủ
                </h3>
                <button onclick="this.closest('#paymentWarningModal').remove()" style="background: none; border: none; font-size: 24px; color: white; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;">&times;</button>
              </div>
              <div class="modal-body">
              <div style="margin-bottom: 18px; color: #333; font-size: 15px;">
                <i class='fas fa-info-circle' style='color: #1976d2; margin-right: 6px;'></i>
                <span>${message}</span>
              </div>
              <div style="font-weight: bold; color: #d32f2f; margin-bottom: 18px;">Vui lòng hoàn thành thanh toán trước khi lấy mẫu.</div>
              <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <a href="/payment-management" class="btn btn-primary" style="background: #2196f3; color: white; border: none; border-radius: 6px; padding: 10px 18px; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 6px;">
                  <i class='fas fa-credit-card'></i> Đi đến Quản lý thanh toán
                </a>
                <button onclick="this.closest('#paymentWarningModal').remove()" class="btn" style="background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 6px; padding: 10px 18px; font-weight: 500;">Đóng</button>
              </div>
            </div>
          </div>
          `;
          document.body.appendChild(modal);
          // Đóng modal khi click ra ngoài
          modal.addEventListener('click', function(e) {
            if (e.target === modal) {
              modal.remove();
            }
          });
        }

        // Sửa xử lý filter: luôn gọi lại backend, không filter trên client
        document
          .getElementById("filterForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const date = document.getElementById("dateFilter").value;
            const status = document.getElementById("statusFilter").value;
            const serviceValue = document.getElementById("serviceFilter").value;
            const searchQuery = document.getElementById("searchFilter").value;

            let serviceId = "";
            if (serviceValue) {
              serviceId = serviceValue;
            }

            currentFilters = {
              serviceId,
              date,
              status,
              searchQuery,
            };
            fetchAppointments(0, pageSize, currentFilters);
          });

        // Hiển thị thông báo thành công
        function showSuccessToast(message) {
          const toast = document.createElement("div");
          toast.className = "toast-notification";
          toast.innerHTML = `
            <div class="toast-content">
              <i class="fas fa-check-circle" style="color: #4caf50; margin-right: 8px;"></i>
              ${message}
            </div>
          `;
          document.body.appendChild(toast);

          // Tự động ẩn toast sau 3 giây
          setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        // Hiển thị thông báo lỗi
        function showErrorToast(message) {
          const toast = document.createElement("div");
          toast.className = "toast-notification error";
          toast.innerHTML = `
            <div class="toast-content">
              <i class="fas fa-exclamation-circle" style="color: #f44336; margin-right: 8px;"></i>
              ${message}
            </div>
          `;
          document.body.appendChild(toast);

          // Tự động ẩn toast sau 3 giây
          setTimeout(() => {
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        // Thêm style cho toast notification
        const style = document.createElement("style");
        style.textContent = `
          .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            z-index: 1000;
          }

          .toast-notification.error {
            border-left: 4px solid #f44336;
          }

          .toast-content {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #333;
          }

          @keyframes slideInRight {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }

          @keyframes fadeOut {
            from {
              opacity: 1;
            }
            to {
              opacity: 0;
            }
          }

          .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
          }

          .status-booked {
            background-color: rgba(33, 150, 243, 0.1);
            color: #2196f3;
          }

          .status-waiting {
            background-color: rgba(255, 152, 0, 0.1);
            color: #ff9800;
          }

          .status-received {
            background-color: rgba(25, 118, 210, 0.1);
            color: #1976d2;
          }

          .status-completed {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
          }

          .status-delivered {
            background-color: rgba(0, 150, 136, 0.1);
            color: #009688;
          }

          .status-cancelled {
            background-color: rgba(244, 67, 54, 0.1);
            color: #f44336;
          }

          /* CSS cho các trạng thái mới */
          .status-kit-pending {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
          }

          .status-kit-received {
            background-color: rgba(156, 39, 176, 0.1);
            color: #9c27b0;
          }

          .status-kit-returned {
            background-color: rgba(63, 81, 181, 0.1);
            color: #3f51b5;
          }

          .status-not-sampled {
            background-color: rgba(3, 169, 244, 0.1);
            color: #03a9f4;
          }

          .status-sampling-completed {
            background-color: rgba(139, 195, 74, 0.1);
            color: #8bc34a;
          }

          .status-sample-error {
            background-color: rgba(255, 87, 34, 0.1);
            color: #ff5722;
          }

          .status-final-completed {
            background-color: rgba(76, 175, 80, 0.1);
            color: #4caf50;
          }

          .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
            cursor: pointer;
          }

          .btn-primary {
            background: linear-gradient(45deg, #2196f3, #1976d2);
            color: white;
          }

          .btn-success {
            background: linear-gradient(45deg, #4caf50, #388e3c);
            color: white;
          }
        `;
        document.head.appendChild(style);

        // Render mặc định khi load trang
        document.addEventListener("DOMContentLoaded", function () {
          fetchAppointments();
        });

        // Hàm reset filter
        function resetFilter() {
          document.getElementById("filterForm").reset();
          currentFilters = {
            serviceId: "",
            date: "",
            status: "",
            searchQuery: "",
          };
          fetchAppointments(0, pageSize, currentFilters);
        }
      </script>
    </div>

    <!-- Phần code ở đây -->

    <script>
      // Modal HTML cho chỉnh sửa lịch hẹn
      const editAppointmentModalHtml = `  <div id="edit-appointment-modal" style="
  display:none;position:fixed;z-index:10000;top:0;left:0;width:100vw;height:100vh;
  background:rgba(30,42,60,0.35);backdrop-filter:blur(2px);
  justify-content:center;align-items:center;transition:background 0.3s;overflow:auto;">
  <div style="
    background:#fff;border-radius:18px;max-width:80vw;width:95vw;
    box-shadow:0 8px 32px rgba(0,0,0,0.18),0 1.5px 8px rgba(33,150,243,0.08);
    padding:0;position:relative;overflow:auto;animation:modalFadeIn 0.35s;
    margin:30px auto;">
    <button id="edit-appointment-close" style="
      position:absolute;top:12px;right:18px;background:rgba(33,150,243,0.08);
      border:none;font-size:26px;cursor:pointer;color:#2196f3;
      border-radius:50%;width:36px;height:36px;transition:background 0.2s;
      z-index:10001;">
      &times;
    </button>
    <iframe id="edit-appointment-iframe" src="" style="
      width:100%;height:85vh;border:none;display:block;
      border-radius:18px;overflow:auto;background:transparent;" scrolling="auto"></iframe>
  </div>
</div>
  <style>
    @keyframes modalFadeIn {
      from { transform: translateY(40px) scale(0.97); opacity: 0; }
      to   { transform: translateY(0) scale(1); opacity: 1; }
    }
    #edit-appointment-modal::-webkit-scrollbar,
    #edit-appointment-modal > div::-webkit-scrollbar { display: none; }
    #edit-appointment-modal, #edit-appointment-modal > div { scrollbar-width: none; }
    #edit-appointment-close:hover { background:rgba(33,150,243,0.18);}
    
    /* Thêm media query cho modal chỉnh sửa */
    @media (max-width: 768px) {
      #edit-appointment-modal > div {
        max-width: 95vw;
        margin: 20px auto;
      }
      #edit-appointment-iframe {
        height: 80vh;
      }
    }
  </style>
`;
      if (!document.getElementById("edit-appointment-modal")) {
        document.body.insertAdjacentHTML("beforeend", editAppointmentModalHtml);
        document.getElementById("edit-appointment-close").onclick = function (
          e
        ) {
          // Ngăn chặn sự kiện mặc định để tránh redirect
          if (e && e.preventDefault) e.preventDefault();
          if (e && e.stopPropagation) e.stopPropagation();

          // Xóa src trước khi ẩn modal để tránh các redirect từ frame
          const iframe = document.getElementById("edit-appointment-iframe");
          iframe.src = "about:blank";

          // Ẩn modal
          document.getElementById("edit-appointment-modal").style.display =
            "none";

          // Trả về false để ngăn chặn các hành vi mặc định khác
          return false;
        };

        document.getElementById("edit-appointment-modal").onclick = function (
          e
        ) {
          if (e.target === this) {
            // Ngăn chặn sự kiện mặc định và lan truyền
            if (e && e.preventDefault) e.preventDefault();
            if (e && e.stopPropagation) e.stopPropagation();

            // Xóa src trước khi ẩn modal
            const iframe = document.getElementById("edit-appointment-iframe");
            iframe.src = "about:blank";

            // Ẩn modal
            this.style.display = "none";

            return false;
          }
        };
      }
    </script>
    <!-- Include the auth and API JS files -->
    <script src="/assets/js/staff-api.js"></script>
    <script src="/assets/js/staff-auth.js"></script>
    <script src="/assets/js/staff-main.js"></script>
    <script src="/assets/js/staff-modal-utils.js"></script>



    <script>
      // Hàm hiển thị modal chi tiết lịch hẹn
      function viewAppointmentDetails(id) {
        // Truy vấn dữ liệu lịch hẹn từ danh sách
        const appointment = appointmentsData.find((a) => a.id == id);
        if (!appointment) {
          alert("Không tìm thấy thông tin lịch hẹn!");
          return;
        }

        const modal = document.createElement("div");
        modal.className = "appointment-details-modal";
        modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
          justify-content: center;
          z-index: 1000;
        `;

        const appointmentInfo =
          appointment.method === "Tại nhà"
            ? `<strong style="color: #666;">Địa chỉ:</strong>
               <span>${appointment.address || "Không có"}</span>`
            : `<strong style="color: #666;">Ngày giờ hẹn:</strong>
               <span>${appointment.appointmentDateTime || "Không có"}</span>`;

        // Use the detailed fee data from backend - chỉ hiển thị thông tin thanh toán nếu không phải trạng thái "Đã đặt"
        const totalAmount = appointment.totalAmount || 0;
        const paidAmount = appointment.paidAmount || 0;
        const remainingAmount = appointment.remainingAmount || 0;

        modal.innerHTML = `
          <div class="modal-content" style="background-color: white; border-radius: 12px; padding: 0; width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
              <div class="modal-title">Chi tiết lịch hẹn</div>
              <button class="modal-close" onclick="this.closest('.appointment-details-modal').remove()">×</button>
            </div>
            <div class="modal-body">

            <div style="display: grid; grid-template-columns: 140px 1fr; gap: 12px; margin-bottom: 25px;">
              <strong style="color: #666;">Tên khách hàng:</strong>
              <span>${appointment.customerName}</span>

              <strong style="color: #666;">Email:</strong>
              <span>${appointment.email || "Không có"}</span>

              <strong style="color: #666;">Số điện thoại:</strong>
              <span>${appointment.phone || "Không có"}</span>

              <strong style="color: #666;">Mã lịch hẹn:</strong>
              <span>${appointment.id}</span>

              <strong style="color: #666;">Ngày đặt lịch:</strong>
              <span>${appointment.bookingDate ? appointment.bookingDate.substring(0, 10) : "Không có"}</span>

              <strong style="color: #666;">Mục đích:</strong>
              <span>${appointment.ADNService || "Không có"}</span>

              <strong style="color: #666;">Phương thức:</strong>
              <span>${appointment.method}</span>

              ${appointmentInfo}
            </div>

            <div style="margin-bottom: 12px;">
              <strong style="color: #666;">Trạng thái:</strong>
              <span>${renderStatusBadge(appointment.status)}</span>
            </div>
            <div style="margin-bottom: 12px;">
              <strong style="color: #666;">Ghi chú:</strong>
              <span style="white-space: pre-wrap; word-wrap: break-word;">${appointment.note || "Không có ghi chú"}</span>
            </div>
            <div style="margin-bottom: 12px;">
              <strong style="color: #666;">Số người tham gia:</strong>
              <span>${appointment.numParticipants != null ? appointment.numParticipants : "Không rõ"}</span>
            </div>

            ${appointment.status === "Đã đặt" || appointment.status === "Chưa thanh toán" ? `
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="color: #856404; font-weight: 500;">
                  <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                  ${appointment.status === "Đã đặt" ? "Lịch hẹn đã được đặt" : "Lịch hẹn chưa thanh toán"}
                </div>
                <button onclick="openCancelAppointmentModal(${appointment.id})" style="
                  background: #dc3545; color: white; border: none; border-radius: 6px; 
                  padding: 8px 16px; cursor: pointer; font-weight: 500; font-size: 14px;
                  display: flex; align-items: center; gap: 6px; transition: all 0.2s;
                " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
                  <i class="fas fa-times"></i> Hủy lịch hẹn
                </button>
              </div>
            </div>
            ` : ''}

            ${appointment.status !== "Đã đặt" ? `
            <div>
              <h4 style="color: #2196f3; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-list-ul"></i>
                Chi tiết phí dịch vụ (${appointment.services ? appointment.services.length : 0} dịch vụ)
              </h4>
            ` : ''}

              <div class="service-list">
                ${appointment.services && appointment.services.length > 0 
                  ? appointment.services.map(service => `
                    <div class="service-item">
                      <div style="flex: 1;">
                        <div style="font-weight: 500; color: #333;">${getServiceDisplayName(service.service)}</div>
                        <div style="font-size: 13px; color: #666; margin-top: 4px;">
                          Số lượng mẫu: <b>${service.sampleQuantity != null ? service.sampleQuantity : 2}</b>
                          ${service.extraSamples > 0 ? ` (${service.extraSamples} mẫu thêm)` : ''}
              </div>
                        <div style="font-size: 12px; color: #888; margin-top: 2px;">
                          Phí cơ bản: ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(service.price)}
                        </div>
                        ${service.extraSampleCost > 0 ? `
                          <div style="font-size: 12px; color: #ff9800; margin-top: 2px;">
                            Phí mẫu thêm: ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(service.extraSampleCost)}
                          </div>
                        ` : ''}
                      </div>
                      <div style="font-weight: 600; color: #0d47a1; text-align: right;">
                        ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(service.serviceTotal)}
            </div>
              </div>
                  `).join("")
                  : '<div class="service-item"><div>Không có dịch vụ</div></div>'
                }
        </div>

              ${appointment.surcharges && appointment.surcharges.length > 0 ? `
                <div style="margin-top: 20px;">
                  <h4 style="color: #ff9800; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-plus-circle"></i>
                    Phụ phí (${appointment.surcharges.length} loại)
                  </h4>
                  
                  <div class="service-list" style="background: #fff8e1;">
                    ${appointment.surcharges.map(surcharge => `
                      <div class="service-item">
                        <div style="flex: 1;">
                          <div style="font-weight: 500; color: #e65100;">${surcharge.name}</div>
                          <div style="font-size: 13px; color: #666; margin-top: 4px;">
                            ${surcharge.description || 'Không có mô tả'}
                          </div>
                          <div style="font-size: 12px; color: #888; margin-top: 2px;">
                            ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(surcharge.feePerUnit)} / ${surcharge.unit}
                          </div>
                        </div>
                        <div style="font-weight: 600; color: #e65100; text-align: right;">
                          ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(surcharge.totalAmount)}
                        </div>
                      </div>
                    `).join("")}
                  </div>
                </div>
              ` : ''}

              ${appointment.status !== "Đã đặt" ? `
              <div class="total-amount">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                  <span style="color: #666;">Tổng phí dịch vụ:</span>
                  <span style="color: #0d47a1; font-weight: 500;">
                    ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(appointment.totalServiceAmount || 0)}
                  </span>
                </div>
                ${appointment.totalSurchargeAmount > 0 ? `
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="color: #666;">Tổng phụ phí:</span>
                    <span style="color: #ff9800; font-weight: 500;">
                      ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(appointment.totalSurchargeAmount)}
                    </span>
                  </div>
                ` : ''}
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 2px solid #edf2f7;">
                  <span style="font-weight: 600; color: #333;">Tổng cộng:</span>
                  <span style="color: #0d47a1; font-size: 20px; font-weight: 600;">
                  ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(totalAmount)}
                </span>
                </div>
                ${paidAmount > 0 ? `
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <span style="color: #666;">Đã thanh toán:</span>
                    <span style="color: #4caf50; font-weight: 500;">
                      ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(paidAmount)}
                    </span>
                  </div>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px;">
                    <span style="color: #666;">Còn lại:</span>
                    <span style="color: ${(remainingAmount > 0 ? '#f44336' : '#4caf50')}; font-weight: 500;">
                      ${new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(remainingAmount)}
                    </span>
                  </div>
                ` : ''}
          </div>
              ` : ''}
            </div>
          </div>
        </div>
        `;

        document.body.appendChild(modal);

        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            modal.style.opacity = "0";
            setTimeout(() => modal.remove(), 300);
          }
        });
      }

      // Hàm chuyển đổi tên dịch vụ
      function getServiceDisplayName(service) {
        switch (service) {
          case "ADN cha-con":
            return "Xét nghiệm ADN Cha - Con";
          case "ADN mẹ-con":
            return "Xét nghiệm ADN Mẹ - Con";
          case "ADN anh,chi-em":
            return "Xét nghiệm ADN Anh/Chị - Em";
          case "ADN ông,bà-cháu":
            return "Xét nghiệm ADN Ông/Bà - Cháu";
          case "ADN họ hàng":
            return "Xét nghiệm ADN họ hàng";
          default:
            return service;
        }
      }

      // Hàm mở modal hủy lịch hẹn
      function openCancelAppointmentModal(appointmentId) {
        const appointment = appointmentsData.find((a) => a.id == appointmentId);
        if (!appointment) {
          alert("Không tìm thấy thông tin lịch hẹn!");
          return;
        }

        const modal = document.createElement("div");
        modal.className = "cancel-appointment-modal";
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
          background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10002;
        `;

        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 0; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;">
            <div class="modal-header" style="background: #667eea; color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; margin: 0;">
              <h3 style="margin: 0; color: white; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                <i class='fas fa-exclamation-triangle'></i> Hủy lịch hẹn
              </h3>
              <button onclick="this.closest('.cancel-appointment-modal').remove()" style="background: none; border: none; font-size: 24px; color: white; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;">&times;</button>
            </div>
            <div class="modal-body">
            
            <div style="margin-bottom: 20px; color: #666; font-size: 15px;">
              <p><strong>Lịch hẹn:</strong> #${appointment.id}</p>
              <p><strong>Khách hàng:</strong> ${appointment.customerName}</p>
              <p><strong>Ngày đặt:</strong> ${appointment.bookingDate ? appointment.bookingDate.substring(0, 10) : "Không có"}</p>
            </div>

            <form id="cancel-form">
              <div style="margin-bottom: 18px;">
                <label style="font-weight: 500; color: #333; margin-bottom: 10px; display: block;">Lý do hủy lịch hẹn:</label>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 16px;">
                  <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                      <input type="radio" name="cancel-reason" value="Khách hàng yêu cầu hủy" style="margin: 0;">
                      <span>Khách hàng yêu cầu hủy</span>
                    </label>
                  </div>
                  <div style="margin-bottom: 12px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                      <input type="radio" name="cancel-reason" value="Không muốn xét nghiệm nữa" style="margin: 0;">
                      <span>Không muốn xét nghiệm nữa</span>
                    </label>
                  </div>
                  <div>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                      <input type="radio" name="cancel-reason" value="other" style="margin: 0;">
                      <span>Lý do khác</span>
                    </label>
                  </div>
                </div>
              </div>

              <div id="other-reason-container" style="display: none; margin-bottom: 18px;">
                <label style="font-weight: 500; color: #333; margin-bottom: 8px; display: block;">Nhập lý do cụ thể:</label>
                <textarea id="other-reason-text" placeholder="Vui lòng nhập lý do hủy lịch hẹn..." style="
                  width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;
                "></textarea>
              </div>

              <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" onclick="this.closest('.cancel-appointment-modal').remove()" style="
                  background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 6px; 
                  padding: 10px 20px; cursor: pointer; font-weight: 500;
                ">Hủy bỏ</button>
                <button type="submit" style="
                  background: #dc3545; color: white; border: none; border-radius: 6px; 
                  padding: 10px 20px; cursor: pointer; font-weight: 500;
                ">Xác nhận hủy</button>
              </div>
            </form>
            </div>
          </div>
        `;

        document.body.appendChild(modal);

        // Xử lý hiển thị textarea khi chọn "Lý do khác"
        const reasonRadios = modal.querySelectorAll('input[name="cancel-reason"]');
        const otherReasonContainer = modal.querySelector('#other-reason-container');

        reasonRadios.forEach((radio) => {
          radio.addEventListener("change", function () {
            if (this.value === "other") {
              otherReasonContainer.style.display = "block";
              otherReasonContainer.style.animation = "fadeIn 0.3s ease";
            } else {
              otherReasonContainer.style.display = "none";
            }
          });
        });

        // Xử lý submit form
        const form = modal.querySelector("#cancel-form");
        form.addEventListener("submit", function(e) {
          e.preventDefault();
          handleCancelAppointmentSubmit(appointmentId, modal);
        });

        // Đóng modal khi click ra ngoài
        modal.addEventListener("click", function(e) {
          if (e.target === modal) modal.remove();
        });
      }

      // Hàm xử lý submit hủy lịch hẹn
      async function handleCancelAppointmentSubmit(appointmentId, modal) {
        try {
          const selectedReason = modal.querySelector('input[name="cancel-reason"]:checked');
          
          if (!selectedReason) {
            alert("Vui lòng chọn lý do hủy lịch hẹn");
            return;
          }

          let reason = selectedReason.value;
          if (reason === "other") {
            const otherReasonText = modal.querySelector('#other-reason-text').value.trim();
            if (!otherReasonText) {
              alert("Vui lòng nhập lý do hủy lịch hẹn");
              return;
            }
            reason = otherReasonText;
          }

          // Gọi API hủy lịch hẹn
          const response = await fetch(`/booking/cancel?bookingId=${appointmentId}&reason=${encodeURIComponent(reason)}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
          });

          if (response.status === 401) {
            window.location.href = "/internal-login";
            return;
          }

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(errorText);
          }

          const result = await response.text();
          modal.remove();
          showSuccessToast("Hủy lịch hẹn thành công!");
          fetchAppointments(currentPage, pageSize, currentFilters);
        } catch (error) {
          console.error("Lỗi khi hủy lịch hẹn:", error);
          alert("Có lỗi khi hủy lịch hẹn: " + error.message);
        }
      }
    </script>


    <script>
      // === Checkin Modal & Submit ===
      function openCheckinModal(appointmentId) {
        const appointment = appointmentsData.find((a) => a.id == appointmentId);
        if (!appointment) {
          alert("Không tìm thấy thông tin lịch hẹn!");
          return;
        }
        // Modal xác nhận đơn giản
        const modal = document.createElement("div");
        modal.className = "checkin-modal";
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
          background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10002;`;
        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 0; width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden;">
            <div class="modal-header" style="background: #667eea; color: white; padding: 20px 30px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; margin: 0;">
              <h3 style="margin: 0; color: white; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                <i class='fas fa-check'></i> Xác nhận Checkin
              </h3>
              <button onclick="this.closest('.checkin-modal').remove()" style="background: none; border: none; font-size: 24px; color: white; cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s;">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px 30px;">
              <div style="margin-bottom: 18px; color: #333; font-size: 16px;">Bạn có chắc chắn muốn checkin lịch hẹn <b>#${appointment.id}</b> không?</div>
              <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" onclick="this.closest('.checkin-modal').remove()" style="background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-weight: 500;">Hủy</button>
                <button type="button" id="confirm-checkin-btn" style="background: #ff9800; color: white; border: none; border-radius: 6px; padding: 10px 20px; cursor: pointer; font-weight: 500;">Xác nhận</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        // Xử lý xác nhận
        modal.querySelector('#confirm-checkin-btn').onclick = async function() {
          try {
            // Gọi API chuyển trạng thái sang 'Chưa thanh toán'
            const response = await fetch(`/booking/appointments/${appointmentId}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ ...appointment, status: "Chưa thanh toán" })
            });
            if (response.status === 401) {
              window.location.href = "/internal-login";
              return;
            }
            if (!response.ok) throw new Error(await response.text());
            modal.remove();
            showSuccessToast("Checkin thành công! Đã chuyển sang trạng thái chưa thanh toán.");
            fetchAppointments(currentPage, pageSize, currentFilters);
          } catch (error) {
            alert("Có lỗi khi checkin: " + error.message);
          }
        };
        // Đóng modal khi click ra ngoài
        modal.addEventListener("click", function(e) {
          if (e.target === modal) modal.remove();
        });
      }
    </script>

    <script>
      // Đảm bảo có hàm openEditAppointmentModal để mở editappointment.html trong modal/iframe
      function openEditAppointmentModal(appointmentId) {
        // Giả sử đã có modal/iframe edit-appointment-modal như trước
        const modal = document.getElementById("edit-appointment-modal");
        const iframe = document.getElementById("edit-appointment-iframe");
        if (modal && iframe) {
          iframe.src = `/edit-appointment?appointmentId=${appointmentId}`;
          modal.style.display = "flex";
        } else {
          // Nếu không có modal, chuyển trang trực tiếp
          window.location.href = `/edit-appointment?appointmentId=${appointmentId}`;
        }
      }
    </script>


    <script>
      document.addEventListener("DOMContentLoaded", function () {
        if (window.renderStaffSidebarInfo) window.renderStaffSidebarInfo();
      });
    </script>

    <script>
    // Hàm mở modal thêm thanh toán khi bấm nút Thanh toán
    function handlePayment(bookingId) {
      const booking = appointmentsData.find(a => a.id == bookingId);
      if (!booking) {
        alert('Không tìm thấy thông tin lịch hẹn!');
        return;
      }
      window.openAddPaymentModal({
        booking: {
          id: booking.id,
          customerName: booking.customerName,
          remainingAmount: booking.remainingAmount,
          paymentMethod: booking.paymentMethod, // nếu có
          method: booking.method
        },
        onSubmit: async (data, modal) => {
          try {
            // Sau khi tạo thanh toán, cập nhật trạng thái booking nếu cần
            const res = await fetch(`/booking/staff/appointments/${booking.id}/status`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ status: 'Chưa lấy mẫu' })
            });
            if (!res.ok) throw new Error(await res.text());
            if (typeof window.showSuccessToast === 'function') {
              window.showSuccessToast('Tạo thanh toán và cập nhật trạng thái thành công!');
            }
            modal.remove();
            fetchAppointments(currentPage, pageSize, currentFilters);
          } catch (err) {
            if (typeof window.showErrorToast === 'function') window.showErrorToast('Lỗi khi cập nhật trạng thái: ' + err.message);
          }
        }
      });
    }
    

    
    // Hàm thêm kết quả (mở modal universal)
    async function handleAddResult(bookingId) {
      const booking = appointmentsData.find(a => a.id == bookingId);
      
      if (!booking || !Array.isArray(booking.services) || booking.services.length === 0) {
        alert('Không tìm thấy dịch vụ của lịch hẹn!');
        return;
      }
      
      try {
        // Load real services data from backend
        const response = await fetch(`/results/booking/${bookingId}/services`);
        
        if (response.ok) {
          const backendServices = await response.json();
          
          // Map backend data to frontend format
          const services = backendServices.map(s => ({
            serviceId: s.serviceId,
            serviceName: s.serviceName,
            resultFile: s.resultFile || null,
            hasResult: s.hasResult || false
          }));
          
          if (typeof window.openResultModalUniversal === 'function') {
            window.openResultModalUniversal({
              bookingId: booking.id,
              services,
              bookingInfo: {
                id: booking.id,
                customerName: booking.customerName,
                bookingDate: booking.bookingDate,
                method: booking.method
              },
              onSubmit: (data, modal, idx) => {
                // Hiển thị thông báo thành công
                if (typeof window.showSuccessToast === 'function') {
                  window.showSuccessToast(`Đã lưu kết quả thành công! File: ${data.fileName}`);
                } else {
                  alert(`Đã lưu kết quả thành công! File: ${data.fileName}`);
                }
                
                // Đóng modal
                if (modal) modal.remove();
                
                // Refresh lại danh sách appointments để cập nhật dữ liệu mới
                fetchAppointments(currentPage, pageSize, currentFilters);
              },
              onClose: (modal) => {
                // Modal closed callback
              }
            });
          } else {
            alert('Chưa load xong modal universal!');
          }
        } else {
          // Fallback to cached data - need to extract serviceId properly
          const services = booking.services.map((s, index) => {
            // Try to extract serviceId from different possible locations
            let serviceId = null;
            if (s.serviceId) {
              serviceId = s.serviceId;
            } else if (s.service && s.service.id) {
              serviceId = s.service.id;
            } else {
              // If no serviceId found, use index + 1 as fallback
              serviceId = index + 1;
            }
            
            return {
              serviceId: serviceId,
              serviceName: s.service || s.serviceName || `Dịch vụ ${index + 1}`,
              resultFile: s.resultFile || null
            };
          });
          
          if (typeof window.openResultModalUniversal === 'function') {
            window.openResultModalUniversal({
              bookingId: booking.id,
              services,
              bookingInfo: {
                id: booking.id,
                customerName: booking.customerName,
                bookingDate: booking.bookingDate,
                method: booking.method
              },
              onSubmit: (data, modal, idx) => {
                if (typeof window.showSuccessToast === 'function') {
                  window.showSuccessToast(`Đã lưu kết quả thành công! File: ${data.fileName}`);
                } else {
                  alert(`Đã lưu kết quả thành công! File: ${data.fileName}`);
                }
                if (modal) modal.remove();
                fetchAppointments(currentPage, pageSize, currentFilters);
              }
            });
          }
        }
      } catch (error) {
        console.error('Error loading services data:', error);
        alert('Lỗi khi tải dữ liệu dịch vụ: ' + error.message);
      }
    }
    </script>
  </body>
</html>
