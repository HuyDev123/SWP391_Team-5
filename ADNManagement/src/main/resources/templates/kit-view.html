<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thông Tin Chi Tiết Kit - Dịch Vụ Xét Nghiệm ADN</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Arial, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .kit-view-container {
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        padding: 40px;
        width: 100%;
        max-width: 800px;
        animation: fadeIn 0.5s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .view-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .header-left {
        display: flex;
        align-items: center;
      }

      .view-logo {
        margin-right: 20px;
      }

      .view-logo img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .view-titles h1 {
        color: #2c3e50;
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .view-titles p {
        color: #7f8c8d;
        font-size: 14px;
      }

      .kit-id {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 8px 15px;
        font-size: 14px;
        font-weight: 600;
        color: #2c3e50;
        border: 1px solid #e0e0e0;
      }

      .kit-status {
        display: inline-flex;
        align-items: center;
        padding: 6px 15px;
        border-radius: 30px;
        font-size: 14px;
        font-weight: 500;
        margin-left: 15px;
      }

      .kit-status.status-new {
        background-color: #e3f2fd;
        color: #1976d2;
      }

      .kit-status.status-sent {
        background-color: #e8f5e9;
        color: #388e3c;
      }

      .kit-status.status-processing {
        background-color: #fff8e1;
        color: #ff8f00;
      }

      .kit-status.status-completed {
        background-color: #e0f2f1;
        color: #00796b;
      }

      .info-section {
        background-color: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
      }

      .info-section-title {
        font-size: 16px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }

      .info-section-title i {
        margin-right: 10px;
        color: #3498db;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: rgba(52, 152, 219, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .info-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -15px;
      }

      .info-item {
        flex: 0 0 50%;
        padding: 0 15px;
        margin-bottom: 15px;
      }

      .info-label {
        font-size: 14px;
        color: #7f8c8d;
        margin-bottom: 5px;
      }

      .info-value {
        font-size: 16px;
        color: #2c3e50;
        font-weight: 500;
      }

      .full-width {
        flex: 0 0 100%;
      }

      .sample-list {
        list-style: none;
        padding: 0;
        margin-top: 15px;
      }

      .sample-item {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .sample-info {
        display: flex;
        align-items: center;
      }

      .sample-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgba(52, 152, 219, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        color: #3498db;
      }

      .sample-details h4 {
        font-size: 16px;
        margin-bottom: 3px;
        font-weight: 500;
        color: #2c3e50;
      }

      .sample-details p {
        font-size: 14px;
        color: #7f8c8d;
        margin: 0;
      }

      .sample-status {
        font-size: 13px;
        padding: 4px 10px;
        border-radius: 20px;
      }

      .sample-status.received {
        background-color: #e8f5e9;
        color: #388e3c;
      }

      .sample-status.pending {
        background-color: #fff8e1;
        color: #ff8f00;
      }

      .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }

      .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        font-weight: 500;
      }

      .btn i {
        margin-right: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border: none;
        box-shadow: 0 4px 6px rgba(52, 152, 219, 0.2);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(52, 152, 219, 0.3);
        background: linear-gradient(135deg, #2980b9 0%, #2573a7 100%);
      }

      .action-links {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        font-size: 14px;
      }

      .action-link {
        color: #7f8c8d;
        text-decoration: none;
        transition: color 0.3s;
      }

      .action-link:hover {
        color: #3498db;
      }

      .separator {
        margin: 0 10px;
        color: #bdc3c7;
      }

      .timeline {
        position: relative;
        max-width: 100%;
        margin: 0 auto;
      }

      .timeline-item {
        padding: 15px 30px;
        position: relative;
        border-left: 2px solid #e0e0e0;
        margin-left: 20px;
      }

      .timeline-item::before {
        content: "";
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background-color: white;
        border: 2px solid #3498db;
        position: absolute;
        left: -8.5px;
        top: 20px;
      }

      .timeline-item.completed::before {
        background-color: #3498db;
      }

      .timeline-date {
        font-size: 13px;
        color: #7f8c8d;
        margin-bottom: 5px;
      }

      .timeline-content {
        font-size: 15px;
        color: #2c3e50;
      }

      .timeline-note {
        font-size: 13px;
        color: #7f8c8d;
        margin-top: 5px;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .kit-view-container {
          padding: 25px 20px;
        }

        .info-item {
          flex: 0 0 100%;
        }

        .view-header {
          flex-direction: column;
          align-items: flex-start;
        }

        .kit-id {
          margin-top: 15px;
          margin-left: 0;
        }

        .button-group {
          flex-direction: column;
          gap: 10px;
        }

        .btn {
          width: 100%;
        }
      }
    </style>
  </head>

  <body>
    <div class="kit-view-container">
      <div class="view-header">
        <div class="header-left">
          <div class="view-logo">
            <img src="assets/images/Logo.jpg" alt="ADN Logo" />
          </div>
          <div class="view-titles">
            <h1>Thông Tin Chi Tiết Kit</h1>
            <p>Theo dõi thông tin và trạng thái kit xét nghiệm</p>
          </div>
        </div>
        <div>
          <div id="kit-code" class="kit-id">KIT20250618001</div>
          <span id="kit-status" class="kit-status status-sent">
            <i
              class="fas fa-circle mr-2"
              style="font-size: 10px; margin-right: 5px"
            ></i>
            Đã gửi
          </span>
        </div>
      </div>

      <div class="info-section">
        <h3 class="info-section-title">
          <i class="fas fa-info-circle"></i> Thông Tin Cơ Bản
        </h3>
        <div class="info-row">
          <div class="info-item">
            <div class="info-label">Loại Kit</div>
            <div id="kit-type" class="info-value">Xác định huyết thống</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ngày gửi</div>
            <div id="send-date" class="info-value">18/06/2025</div>
          </div>
          <div class="info-item">
            <div class="info-label">Số lượng mẫu</div>
            <div id="sample-count" class="info-value">2</div>
          </div>
          <div class="info-item">
            <div class="info-label">Số ngày dự kiến</div>
            <div id="expected-days" class="info-value">14 ngày</div>
          </div>
          <div class="info-item">
            <div class="info-label">Ngày hoàn thành dự kiến</div>
            <div id="expected-completion" class="info-value">02/07/2025</div>
          </div>
          <div class="info-item">
            <div class="info-label">Người phụ trách</div>
            <div id="staff-name" class="info-value">Nguyễn Văn A</div>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3 class="info-section-title">
          <i class="fas fa-user"></i> Thông Tin Khách Hàng
        </h3>
        <div class="info-row">
          <div class="info-item">
            <div class="info-label">Tên khách hàng</div>
            <div id="customer-name" class="info-value">Trần Văn Khách</div>
          </div>
          <div class="info-item">
            <div class="info-label">Số điện thoại</div>
            <div id="customer-phone" class="info-value">0987654321</div>
          </div>
          <div class="info-item">
            <div class="info-label">Email</div>
            <div id="customer-email" class="info-value">khach@example.com</div>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3 class="info-section-title">
          <i class="fas fa-flask"></i> Danh Sách Mẫu
        </h3>
        <ul class="sample-list" id="sample-list">
          <!-- Mẫu sẽ được thêm bằng JavaScript -->
          <li class="sample-item">
            <div class="sample-info">
              <div class="sample-icon">
                <i class="fas fa-vial"></i>
              </div>
              <div class="sample-details">
                <h4>Mẫu 1 - Bố</h4>
                <p>Mã mẫu: SM2506250001</p>
              </div>
            </div>
            <span class="sample-status received">Đã nhận</span>
          </li>

          <li class="sample-item">
            <div class="sample-info">
              <div class="sample-icon">
                <i class="fas fa-vial"></i>
              </div>
              <div class="sample-details">
                <h4>Mẫu 2 - Con</h4>
                <p>Mã mẫu: SM2506250002</p>
              </div>
            </div>
            <span class="sample-status received">Đã nhận</span>
          </li>
        </ul>
      </div>

      <div class="info-section">
        <h3 class="info-section-title">
          <i class="fas fa-clipboard-list"></i> Ghi Chú
        </h3>
        <div class="info-row">
          <div class="info-item full-width">
            <div id="notes" class="info-value">
              Kit đã được kiểm tra và ghi nhận đầy đủ thông tin. Khách hàng yêu
              cầu kết quả sớm.
            </div>
          </div>
        </div>
      </div>

      <div class="info-section">
        <h3 class="info-section-title">
          <i class="fas fa-history"></i> Lịch Sử Cập Nhật
        </h3>
        <div class="timeline">
          <div class="timeline-item completed">
            <div class="timeline-date">18/06/2025 - 09:15</div>
            <div class="timeline-content">Tạo Kit mới</div>
            <div class="timeline-note">Nhân viên: Nguyễn Văn A</div>
          </div>

          <div class="timeline-item completed">
            <div class="timeline-date">18/06/2025 - 14:30</div>
            <div class="timeline-content">Gửi Kit cho khách hàng</div>
            <div class="timeline-note">Đã gửi qua đường bưu điện</div>
          </div>

          <div class="timeline-item">
            <div class="timeline-date">20/06/2025 - 10:45</div>
            <div class="timeline-content">Nhận mẫu từ khách hàng</div>
          </div>

          <div class="timeline-item">
            <div class="timeline-date">22/06/2025 - 08:00</div>
            <div class="timeline-content">Bắt đầu phân tích mẫu</div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <a href="list-kit.html" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i> Quay lại danh sách
        </a>

        <a href="editkit.html" class="btn btn-primary" id="edit-kit-btn">
          <i class="fas fa-edit"></i> Chỉnh sửa Kit
        </a>
      </div>

      <div class="action-links">
        <a href="#" class="action-link" id="print-kit">
          <i class="fas fa-print"></i> In thông tin
        </a>
        <span class="separator">|</span>
        <a href="#" class="action-link" id="export-pdf">
          <i class="fas fa-file-pdf"></i> Xuất PDF
        </a>
        <span class="separator">|</span>
        <a href="index.html" class="action-link">
          <i class="fas fa-home"></i> Trang chủ
        </a>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/auth-check.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        // Lấy ID Kit từ URL
        // const urlParams = new URLSearchParams(window.location.search);
        // const kitId = urlParams.get('id');

        // if (!kitId) {
        //   alert('Không tìm thấy ID Kit');
        //   window.location.href = 'list-kit.html';
        //   return;
        // }

        // Cập nhật URL của nút Edit
        document.getElementById(
          "edit-kit-btn"
        ).href = `editkit.html?id=${kitId}`;

        try {
          // Lấy thông tin Kit từ API
          const response = await fetch(`/api/kits/${kitId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (!response.ok) {
            throw new Error("Không thể lấy thông tin Kit");
          }

          const kitData = await response.json();

          // Hiển thị thông tin Kit
          displayKitInfo(kitData);

          // Hiển thị danh sách mẫu
          if (kitData.samples && kitData.samples.length > 0) {
            displaySamples(kitData.samples);
          }

          // Hiển thị lịch sử cập nhật
          if (kitData.history && kitData.history.length > 0) {
            displayHistory(kitData.history);
          }
        } catch (error) {
          console.error("Lỗi:", error);
          alert("Có lỗi khi tải thông tin Kit. Vui lòng thử lại sau.");
        }

        // Xử lý sự kiện in thông tin
        document
          .getElementById("print-kit")
          .addEventListener("click", function (e) {
            e.preventDefault();
            window.print();
          });

        // Xử lý sự kiện xuất PDF
        document
          .getElementById("export-pdf")
          .addEventListener("click", function (e) {
            e.preventDefault();
            alert("Tính năng xuất PDF đang được phát triển");
          });
      });

      function displayKitInfo(data) {
        // Hiển thị thông tin cơ bản
        document.getElementById("kit-code").textContent = data.kitCode || "";

        // Cập nhật trạng thái Kit
        const kitStatus = document.getElementById("kit-status");
        kitStatus.className = "kit-status";

        switch (data.status) {
          case "new":
            kitStatus.classList.add("status-new");
            kitStatus.innerHTML =
              '<i class="fas fa-circle mr-2" style="font-size: 10px; margin-right: 5px;"></i> Mới tạo';
            break;
          case "sent":
            kitStatus.classList.add("status-sent");
            kitStatus.innerHTML =
              '<i class="fas fa-circle mr-2" style="font-size: 10px; margin-right: 5px;"></i> Đã gửi';
            break;
          case "processing":
            kitStatus.classList.add("status-processing");
            kitStatus.innerHTML =
              '<i class="fas fa-circle mr-2" style="font-size: 10px; margin-right: 5px;"></i> Đang xử lý';
            break;
          case "completed":
            kitStatus.classList.add("status-completed");
            kitStatus.innerHTML =
              '<i class="fas fa-circle mr-2" style="font-size: 10px; margin-right: 5px;"></i> Đã hoàn thành';
            break;
          default:
            kitStatus.classList.add("status-new");
            kitStatus.innerHTML =
              '<i class="fas fa-circle mr-2" style="font-size: 10px; margin-right: 5px;"></i> Không xác định';
        }

        // Hiển thị loại Kit
        const kitTypeMap = {
          paternity: "Xác định huyết thống",
          maternity: "Xác định quan hệ mẹ con",
          sibling: "Xác định anh chị em ruột",
          ancestry: "Phân tích nguồn gốc",
          health: "Sàng lọc gen bệnh",
        };

        document.getElementById("kit-type").textContent =
          kitTypeMap[data.kitType] || data.kitType || "";

        // Định dạng ngày gửi
        if (data.sendDate) {
          const sendDate = new Date(data.sendDate);
          document.getElementById("send-date").textContent =
            sendDate.toLocaleDateString("vi-VN");
        }

        // Hiển thị số lượng mẫu
        document.getElementById("sample-count").textContent =
          data.sampleCount || "0";

        // Hiển thị số ngày dự kiến
        document.getElementById("expected-days").textContent = `${
          data.expectedDays || "14"
        } ngày`;

        // Tính và hiển thị ngày hoàn thành dự kiến
        if (data.sendDate && data.expectedDays) {
          const sendDate = new Date(data.sendDate);
          const completionDate = new Date(sendDate);
          completionDate.setDate(
            sendDate.getDate() + parseInt(data.expectedDays)
          );
          document.getElementById("expected-completion").textContent =
            completionDate.toLocaleDateString("vi-VN");
        }

        // Hiển thị thông tin người phụ trách
        document.getElementById("staff-name").textContent =
          data.staffName || "Chưa phân công";

        // Hiển thị thông tin khách hàng
        document.getElementById("customer-name").textContent =
          data.customerName || "";
        document.getElementById("customer-phone").textContent =
          data.customerPhone || "";
        document.getElementById("customer-email").textContent =
          data.customerEmail || "Không có";

        // Hiển thị ghi chú
        document.getElementById("notes").textContent =
          data.notes || "Không có ghi chú";
      }

      function displaySamples(samples) {
        const sampleList = document.getElementById("sample-list");
        sampleList.innerHTML = ""; // Xóa mẫu có sẵn

        samples.forEach((sample) => {
          const sampleItem = document.createElement("li");
          sampleItem.className = "sample-item";

          const sampleStatus =
            sample.status === "received" ? "received" : "pending";
          const sampleStatusText =
            sample.status === "received" ? "Đã nhận" : "Chưa nhận";

          sampleItem.innerHTML = `
            <div class="sample-info">
              <div class="sample-icon">
                <i class="fas fa-vial"></i>
              </div>
              <div class="sample-details">
                <h4>${sample.name || `Mẫu ${sample.sampleNumber}`}</h4>
                <p>Mã mẫu: ${sample.sampleCode || "Chưa có mã"}</p>
              </div>
            </div>
            <span class="sample-status ${sampleStatus}">${sampleStatusText}</span>
          `;

          sampleList.appendChild(sampleItem);
        });
      }

      function displayHistory(history) {
        const timeline = document.querySelector(".timeline");
        timeline.innerHTML = ""; // Xóa lịch sử mẫu

        history.forEach((item) => {
          const timelineItem = document.createElement("div");
          timelineItem.className = item.completed
            ? "timeline-item completed"
            : "timeline-item";

          // Định dạng ngày giờ
          const date = new Date(item.timestamp);
          const formattedDate = `${date.toLocaleDateString(
            "vi-VN"
          )} - ${date.toLocaleTimeString("vi-VN", {
            hour: "2-digit",
            minute: "2-digit",
          })}`;

          timelineItem.innerHTML = `
            <div class="timeline-date">${formattedDate}</div>
            <div class="timeline-content">${item.action}</div>
            ${item.note ? `<div class="timeline-note">${item.note}</div>` : ""}
          `;

          timeline.appendChild(timelineItem);
        });
      }
    </script>
  </body>
</html>
